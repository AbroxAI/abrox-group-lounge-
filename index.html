<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox â€“ Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="emoji-pack.js" defer></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#2ecc71',
        bubble:'#262b38',
        bubbleOut:'#2b3242',
        send:'#3b82f6'
      }
    }
  }
}
</script>

<style>
/* ===== TELEGRAM RHYTHM ===== */
.msg{display:flex;gap:8px;margin-bottom:8px}
.grouped{margin-top:-6px}
.msg.out{justify-content:flex-end}

/* ===== BUBBLES ===== */
.bubble{
  padding:8px 14px 7px;
  font-size:13px;
  line-height:1.45;
  max-width:78%;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
}
.msg.in .bubble{background:#262b38;border-radius:6px 18px 18px 6px}
.msg.out .bubble{background:#2b3242;border:1px solid #343a4a;border-radius:18px 6px 6px 18px}

/* ===== META ===== */
.sender{font-size:11px;font-weight:600;color:#2ecc71;margin-bottom:4px}
.time{font-size:10px;opacity:.7;margin-top:6px;display:flex;justify-content:flex-end}
.read-by{display:flex;gap:4px;margin-top:4px;justify-content:flex-end}
.read-by img{width:13px;height:13px;border-radius:999px;border:1px solid #1c1f26}
.date-sep{text-align:center;font-size:11px;color:#a0a6b5;margin:12px 0}

/* ===== UNREAD DIVIDER ===== */
.unread-divider{
  text-align:center;
  font-size:11px;
  color:#2ecc71;
  margin:12px 0;
  position:relative;
}
.unread-divider::before,
.unread-divider::after{
  content:'';
  position:absolute;
  top:50%;
  width:30%;
  height:1px;
  background:#2ecc71;
}
.unread-divider::before{left:0}
.unread-divider::after{right:0}

/* ===== VERIFIED GEM ===== */
.verified-bubble{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  background:linear-gradient(180deg,#1b6d46,#125034);
  color:#d8f6e2;
  font-size:11px;
}

/* ===== GROUP TYPING BAR ===== */
.group-typing-bar{
  display:none;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.03);
  color:#2ecc71;
}

/* ===== INLINE TYPING ROW ===== */
.typing-row{display:flex;gap:8px;margin:6px 0}
.typing-dots span{
  width:6px;height:6px;
  background:#2ecc71;
  border-radius:50%;
  display:inline-block;
  animation:dot 1s infinite;
}
.typing-dots span:nth-child(2){animation-delay:120ms}
.typing-dots span:nth-child(3){animation-delay:240ms}
@keyframes dot{50%{transform:translateY(-4px)}}
</style>
</head>

<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">

<main class="flex flex-col flex-1 border-r border-border">

<header class="bg-panel border-b border-border px-4 py-3 flex justify-between items-center">
  <div>
    <div class="text-sm font-semibold">Abrox Binary Bot â€“ Private Lounge</div>
    <div class="text-xs text-muted">Private Group</div>
  </div>
  <div id="groupTypingBar" class="group-typing-bar">
    <div class="typing-dots"><span></span><span></span><span></span></div>
    <span id="typingText">Someone is typingâ€¦</span>
  </div>
</header>

<section id="chat" class="flex-1 overflow-y-auto px-4 py-4">
  <div class="text-center text-muted text-sm">
    ðŸ“Œ <strong>Group Rules</strong><br>
    New members are read-only until verified<br>
    No screenshots Â· Admins DM only
  </div>
</section>

<footer class="bg-panel border-t border-border px-4 py-3">
  <div class="flex items-center gap-2">
    <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
    <button id="send" class="hidden"><i data-lucide="send"></i></button>
    <button id="micBtn"><i data-lucide="mic"></i></button>
  </div>
</footer>

</main>

<script>
lucide.createIcons();

/* ===== CORE STATE ===== */
const chat=document.getElementById('chat');
const input=document.getElementById('input');
const send=document.getElementById('send');
const micBtn=document.getElementById('micBtn');
const typingBar=document.getElementById('groupTypingBar');
const typingText=document.getElementById('typingText');

/* ===== TYPING ENGINE (HUMAN, TELEGRAM-LIKE) ===== */
const activeTypers=new Map();
let typingTimers=new Map();

function updateTypingUI(){
  if(activeTypers.size===0){
    typingBar.style.display='none';
    return;
  }
  typingBar.style.display='flex';
  typingText.textContent =
    [...activeTypers.keys()].length===1
      ? `${[...activeTypers.keys()][0]} is typingâ€¦`
      : `Several people are typingâ€¦`;
}

function showTyping(member){
  if(activeTypers.has(member.name)) return;
  activeTypers.set(member.name,true);
  updateTypingUI();

  const cancelDelay=2500+Math.random()*3000;
  const t=setTimeout(()=>{
    hideTyping(member);
  },cancelDelay);
  typingTimers.set(member.name,t);

  const row=document.createElement('div');
  row.className='typing-row';
  row.dataset.typing=member.name;
  row.innerHTML=`
    <img class="avatar" src="${member.avatar}">
    <div class="typing-dots"><span></span><span></span><span></span></div>
  `;
  chat.appendChild(row);
  chat.scrollTop=chat.scrollHeight;
}

function hideTyping(member){
  activeTypers.delete(member.name||member);
  updateTypingUI();
  clearTimeout(typingTimers.get(member.name));
  typingTimers.delete(member.name);
  const row=chat.querySelector(`[data-typing="${member.name}"]`);
  if(row) row.remove();
}

/* ===== UNREAD MESSAGES DIVIDER ===== */
let unreadInserted = false;
function insertUnreadDivider(){
  if(unreadInserted) return;
  const div = document.createElement('div');
  div.className = 'unread-divider';
  div.textContent = 'Unread messages';
  chat.appendChild(div);
  unreadInserted = true;
}

/* ===== SCROLL POSITION ===== */
function isAtBottom(){
  return chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 10;
}

/* ===== MESSAGE RENDER ===== */
let lastSender=null;
function renderMessage(m){
  if(!isAtBottom() && !m.out) insertUnreadDivider();

  const el=document.createElement('div');
  el.className=`msg ${m.out?'out':'in'} ${lastSender===m.name?'grouped':''}`;

  const verified =
    m.role==='VERIFIED'
      ? `<span class="verified-bubble"><i data-lucide="gem"></i><span>VERIFIED</span></span>`
      : '';

  el.innerHTML=`
    ${!m.out?`<img class="avatar" src="${m.avatar||''}">`:''}
    <div class="bubble">
      ${lastSender!==m.name&&!m.out?`<div class="sender">${m.name} ${verified}</div>`:''}
      ${m.text}
      <div class="time">âœ“ ${new Date(m.timestamp).toLocaleTimeString([],{
        hour:'2-digit',minute:'2-digit'
      })}</div>
      <div class="read-by"></div>
    </div>
  `;

  chat.appendChild(el);
  lucide.createIcons();

  if(m.out) scheduleReceipts(el);
  lastSender=m.name;
  chat.scrollTop=chat.scrollHeight;
}

/* ===== READ RECEIPTS (STAGGERED + RANDOM VERIFIED) ===== */
function scheduleReceipts(el){
  const time=el.querySelector('.time');
  const read=el.querySelector('.read-by');

  setTimeout(()=>{
    time.textContent=`âœ“âœ“ ${time.textContent.slice(2)}`;
  },500+Math.random()*400);

  setTimeout(()=>{
    time.textContent=`âœ“âœ“ ðŸ‘€ ${time.textContent.slice(2)}`;
    const viewers = members
      .filter(m=>m.role==='VERIFIED')
      .sort(()=>0.5-Math.random())
      .slice(0,2+Math.floor(Math.random()*3));

    viewers.forEach(v=>{
      const img=document.createElement('img');
      img.src=v.avatar;
      read.appendChild(img);
    });
  },1200+Math.random()*600);
}

/* ===== SEND ===== */
send.onclick=()=>{
  if(!input.value.trim()) return;
  const m={
    name:'You',
    role:'VERIFIED',
    text:input.value,
    timestamp:Date.now(),
    out:true
  };
  renderMessage(m);
  input.value='';
};

/* ===== MIC RECORDING (UNCHANGED LOGIC) ===== */
let recorder, chunks=[], stream;
micBtn.onpointerdown=async()=>{
  try{stream=await navigator.mediaDevices.getUserMedia({audio:true});}
  catch{return;}
  recorder=new MediaRecorder(stream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'audio/webm'});
    const url=URL.createObjectURL(blob);
    renderMessage({
      name:'You',
      role:'VERIFIED',
      out:true,
      timestamp:Date.now(),
      text:`<audio controls src="${url}"></audio>`
    });
    stream.getTracks().forEach(t=>t.stop());
  };
  recorder.start();
};
micBtn.onpointerup=()=>recorder&&recorder.stop();

/* ===== INDEXED DB (FULL PRESERVED) ===== */
const DB='AbroxDB',STORE='messages';
let db;
indexedDB.open(DB,1).onupgradeneeded=e=>{
  e.target.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
};
indexedDB.open(DB,1).onsuccess=e=>{
  db=e.target.result;
  const tx=db.transaction(STORE,'readonly').objectStore(STORE);
  tx.getAll().onsuccess=r=>{
    r.target.result.sort((a,b)=>a.timestamp-b.timestamp).forEach(renderMessage);
  };
};
function save(m){
  if(!db) return;
  db.transaction(STORE,'readwrite').objectStore(STORE).add(m);
}

/* ===== EXPOSE LEGACY APIS ===== */
window.showTyping=showTyping;
window.hideTyping=hideTyping;
window.fakeMemberSend=(m,t)=>{
  showTyping(m);
  setTimeout(()=>{
    hideTyping(m);
    renderMessage({
      name:m.name,
      role:m.role,
      avatar:m.avatar,
      text:t,
      timestamp:Date.now(),
      out:false
    });
  },900+Math.random()*1200);
};
</script>
</div>
</body>
</html>
