<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox â€“ Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="emoji-pack.js" defer></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#6bdba7',
        bubble:'#262b38',
        bubbleOut:'#2b3242',
        send:'#3b82f6'
      }
    }
  }
}
</script>

<style>
/* ================= TELEGRAM RHYTHM ================= */
.msg{display:flex;gap:6px;margin-bottom:8px}
.msg.out{justify-content:flex-end}
.grouped{margin-top:-6px}

/* ================= BUBBLES ================= */
.bubble{
  padding:8px 14px 7px;
  font-size:13px;
  line-height:1.45;
  max-width:78%;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
}

.msg.in .bubble{
  background:#262b38;
  border-radius:6px 18px 18px 6px;
}
.msg.out .bubble{
  background:#2b3242;
  border:1px solid #343a4a;
  border-radius:18px 6px 6px 18px;
}

/* ===== AVATAR â†’ BUBBLE TAIL (TELEGRAM-ACCURATE) ===== */
.msg.in .bubble::before{
  content:'';
  position:absolute;
  left:-6px;
  top:14px;
  width:8px;
  height:8px;
  background:#262b38;
  border-radius:0 0 0 8px;
}
.msg.out .bubble::after{
  content:'';
  position:absolute;
  right:-6px;
  top:14px;
  width:8px;
  height:8px;
  background:#2b3242;
  border-radius:0 0 8px 0;
}
.grouped.in .bubble::before,
.grouped.out .bubble::after{display:none}

/* ================= META ================= */
.sender{
  font-size:12px;
  font-weight:600;
  color:#6bdba7;
  margin-bottom:4px;
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
.time{
  font-size:10px;
  opacity:.65;
  margin-top:6px;
  display:flex;
  justify-content:flex-end;
  gap:4px;
}
.read-by{
  display:flex;
  gap:4px;
  margin-top:4px;
  justify-content:flex-end;
}
.read-by img{
  width:13px;
  height:13px;
  border-radius:999px;
  border:1px solid #1c1f26;
}
.date-sep{
  text-align:center;
  font-size:11px;
  color:#a0a6b5;
  margin:12px 0;
}

/* ================= BADGES ================= */
.verified-bubble{
  display:inline-flex;
  align-items:center;
  gap:3px;
  padding:1px 4px;
  border-radius:999px;
  background:linear-gradient(180deg,#1b6d46,#125034);
  color:#d8f6e2;
  font-size:9px;
  line-height:1;
}
.verified-bubble i{width:6px;height:6px;stroke-width:.4}

.role-pill{
  font-size:9px;
  padding:1px 6px;
  border-radius:999px;
  opacity:.85;
}
.role-pill.admin{background:#7f1d1d}
.role-pill.mod{background:#5b21b6}

/* ================= HEADER + TYPING ================= */
header{position:relative}

.group-typing-bar{
  position:absolute;
  right:calc(100% + 6px);
  top:50%;
  transform:translateY(-50%);
  display:flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.03);
  font-size:12px;
  font-weight:500;
  color:#6bdba7;
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
}
.group-typing-bar.active{opacity:1}

.header-members{transition:opacity .18s ease}
header.typing-active .header-members{opacity:0}

/* ================= AVATARS ================= */
.avatar{
  width:32px;
  height:32px;
  border-radius:999px;
}
</style>
</head>

<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">

<!-- ================= HEADER ================= -->
<header id="mainHeader" class="bg-panel border-b border-border px-4 py-3 flex justify-between items-center">
  <div class="flex gap-3 items-center">
    <img src="assets/logo.png" class="w-8 h-8">
    <div>
      <div class="text-sm font-semibold">Abrox Binary Bot â€“ Private Lounge</div>
      <div class="flex items-center gap-1 text-xs text-muted">
        <i data-lucide="lock" class="w-3 h-3"></i>
        <span>Private Group</span>
      </div>
      <div class="text-xs text-muted header-members">
        Members: 4,872 â€¢ Online: <span id="onlineCount">â€”</span>
      </div>
      <div class="text-xs text-muted">
        Demo discussion Â· Verification required
      </div>
    </div>
  </div>

  <div class="flex items-center gap-2 relative">
    <div id="unread-counter" class="hidden px-3 py-1 rounded-full bg-bubbleOut text-xs"></div>

    <div id="group-typing-bar" class="group-typing-bar">
      <span class="w-2 h-2 rounded-full bg-accent"></span>
      <span class="typing-summary">Typingâ€¦</span>
    </div>

    <button id="membersBtn"><i data-lucide="users"></i></button>
  </div>
</header>

<!-- ================= CHAT ================= -->
<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 scroll-smooth">
  <div class="text-center text-muted text-sm mb-4">
    ðŸ“Œ <strong>Group Rules</strong><br>
    New members are read-only until verified<br>
    Admins DM individually<br>
    No screenshots in chat<br>
    Ignore unsolicited messages
  </div>
</section>

<footer class="bg-panel border-t border-border px-4 py-3">
  <div class="flex items-center bg-bg rounded-full px-3 py-2 gap-2">
    <button id="emojiBtn"><i data-lucide="smile"></i></button>
    <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
    <div class="flex items-center gap-2 ml-auto">
      <button id="mediaBtn"><i data-lucide="paperclip"></i></button>
      <button id="micBtn"><i data-lucide="mic"></i></button>
      <button id="send" class="hidden text-send"><i data-lucide="send"></i></button>
    </div>
  </div>
</footer>

</main>

<!-- ===== SIDEBAR ===== -->
<aside id="sidebar" class="fixed right-0 top-0 w-72 h-full bg-panel border-l border-border translate-x-full transition-transform z-50 flex flex-col">
  <div class="p-4 border-b border-border flex items-center justify-between">
    <strong>Members</strong>
    <button id="closeSidebar"><i data-lucide="x"></i></button>
  </div>
  <div class="px-3 pb-3">
    <input id="memberSearch"
      class="w-full bg-bg border border-border rounded-full px-4 py-2 text-sm outline-none"
      placeholder="Search membersâ€¦">
  </div>
  <div id="memberList" class="flex-1 p-3 space-y-4 overflow-y-auto"></div>
</aside>

<script>
/* ================= ICONS ================= */
requestAnimationFrame(()=>lucide.createIcons());

/* ================= CORE ================= */
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const emojiBtn = document.getElementById('emojiBtn');
const mediaBtn = document.getElementById('mediaBtn');
const micBtn = document.getElementById('micBtn');
const sidebar = document.getElementById('sidebar');
const membersBtn = document.getElementById('membersBtn');
const closeSidebar = document.getElementById('closeSidebar');
const memberList = document.getElementById('memberList');
const onlineCount = document.getElementById('onlineCount');
const groupTypingBar = document.getElementById('group-typing-bar');
const unreadCounter = document.getElementById('unread-counter');
const memberSearch = document.getElementById('memberSearch');
const mainHeader = document.getElementById('mainHeader');

/* ================= INPUT ================= */
input.oninput = () => {
  const has = input.value.trim().length > 0;
  send.classList.toggle('hidden', !has);
  mediaBtn.classList.toggle('hidden', has);
  micBtn.classList.toggle('hidden', has);
  typingSelf();
};

/* ================= EMOJI ================= */
emojiBtn.onclick = () => {
  if (window.EmojiPack) EmojiPack.openPicker(input);
};

/* ================= MEMBERS ================= */
const ADMIN={name:'Profit Hunter ðŸŒ',role:'ADMIN',avatar:'assets/admin.jpg'};
const MOD={name:'Kitty Star â­',role:'MOD',avatar:'assets/mod.jpg'};

const members=[ADMIN,MOD,...Array.from({length:18},(_,i)=>({
  name:`Member_${i+1}`,
  role:'VERIFIED',
  avatar:`https://randomuser.me/api/portraits/men/${i+20}.jpg`,
  lastActive:Date.now()-Math.random()*120000
}))];

const ACTIVE=90000;
const isOnline=m=>Date.now()-m.lastActive<ACTIVE;

/* ================= SIDEBAR RENDER ================= */
function renderMembers(q=''){
  q=q.toLowerCase();
  memberList.innerHTML='';
  members
    .filter(m=>!q||m.name.toLowerCase().includes(q))
    .sort((a,b)=>(isOnline(b)-isOnline(a))||a.name.localeCompare(b.name))
    .forEach(m=>{
      memberList.innerHTML+=`
      <div class="flex gap-3 items-center">
        <div class="relative">
          <img src="${m.avatar}" class="w-9 h-9 rounded-full">
          <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${isOnline(m)?'bg-green-500':'bg-gray-500'}"></span>
        </div>
        <div>
          <div class="text-sm">${m.name}</div>
          <span class="text-[10px] px-2 py-[1px] rounded-full ${
            m.role==='ADMIN'?'bg-red-600':
            m.role==='MOD'?'bg-purple-600':'bg-green-600'
          }">${m.role}</span>
        </div>
      </div>`;
    });
  onlineCount.textContent = members.filter(isOnline).length;
}
memberSearch.oninput=e=>renderMembers(e.target.value);
setTimeout(renderMembers,120);

/* ================= TYPING ================= */
const activeTypers=new Map();
let selfTypingTimeout;

function updateTyping(){
  const names=[...activeTypers.keys()].slice(0,2);
  if(!names.length){
    groupTypingBar.classList.remove('active');
    mainHeader.classList.remove('typing-active');
    return;
  }
  groupTypingBar.querySelector('.typing-summary').textContent =
    names.length===1 ? `${names[0]} is typingâ€¦` : `${names.join(', ')} are typingâ€¦`;
  groupTypingBar.classList.add('active');
  mainHeader.classList.add('typing-active');
}

function typingSelf(){
  activeTypers.set('You',Date.now());
  updateTyping();
  clearTimeout(selfTypingTimeout);
  selfTypingTimeout=setTimeout(()=>{
    activeTypers.delete('You');
    updateTyping();
  },1800);
}

/* ================= SEND ================= */
send.onclick=()=>{
  if(!input.value.trim()) return;
  activeTypers.delete('You');
  updateTyping();
  postMessage({name:'You',role:'VERIFIED',text:input.value,out:true});
  input.value='';
  send.classList.add('hidden');
  mediaBtn.classList.remove('hidden');
  micBtn.classList.remove('hidden');
};

/* ================= DATA ================= */
const reactions=new Map();
const reads=new Map();

/* ================= POST ================= */
function postMessage(m){
  m.id=crypto.randomUUID();
  m.timestamp=Date.now();
  save(m);
  render(m);
  sync.postMessage({type:'msg',m});
}

/* ================= RENDER ================= */
let lastMeta=null,lastDate='';
function render(m){
  const d=new Date(m.timestamp);
  if(d.toDateString()!==lastDate){
    const sep=document.createElement('div');
    sep.className='date-sep';
    sep.textContent=d.toDateString();
    chat.appendChild(sep);
    lastDate=d.toDateString();
  }

  const grouped=lastMeta&&lastMeta.sender===m.name&&(d-lastMeta.time)<120000;
  const badge =
    m.role==='ADMIN'?'<span class="role-pill admin">ADMIN</span>':
    m.role==='MOD'?'<span class="role-pill mod">MOD</span>':
    '<span class="verified-bubble"><i data-lucide="gem"></i></span>';

  const el=document.createElement('div');
  el.className=`msg ${m.out?'out':'in'} ${grouped?'grouped':''}`;
  el.dataset.id=m.id;
  el.innerHTML=`
    ${!m.out?`<img class="avatar" src="${members.find(x=>x.name===m.name)?.avatar||''}">`:''}
    <div class="bubble">
      ${!grouped&&!m.out?`<div class="sender">${m.name} ${badge}</div>`:''}
      <div class="content">${m.text}</div>
      <div class="reactions"></div>
      <div class="time">âœ“ ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
    </div>`;
  chat.appendChild(el);
  lucide.createIcons();
  observeRead(el);
  chat.scrollTo({top:chat.scrollHeight,behavior:'smooth'});
  lastMeta={sender:m.name,time:d};
}

/* ================= READ RECEIPTS ================= */
const readerObserver=new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      markRead(e.target.dataset.id);
      readerObserver.unobserve(e.target);
    }
  });
},{root:chat,threshold:.7});

function observeRead(el){readerObserver.observe(el)}

function markRead(id){
  if(!reads.has(id)) reads.set(id,new Set());
  reads.get(id).add('You');
  updateSeen(id);
  sync.postMessage({type:'read',id});
}

function updateSeen(id){
  const el=document.querySelector(`[data-id="${id}"] .time`);
  const count=reads.get(id)?.size||0;
  if(count>2) el.textContent='ðŸ‘ Seen by many';
}

/* ================= REACTIONS ================= */
chat.addEventListener('contextmenu',openMenu);
chat.addEventListener('touchstart',holdStart,{passive:true});

let holdTimer;
function holdStart(e){
  const msg=e.target.closest('.msg');
  if(!msg) return;
  holdTimer=setTimeout(()=>openReactionPicker(msg),500);
}
document.addEventListener('touchend',()=>clearTimeout(holdTimer));

function openMenu(e){
  const msg=e.target.closest('.msg');
  if(!msg) return;
  e.preventDefault();
  openReactionPicker(msg);
}

function openReactionPicker(msg){
  const picker=document.createElement('div');
  picker.className='fixed bg-panel border border-border rounded-xl p-2 flex gap-2 z-50';
  ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ”¥','ðŸ˜®'].forEach(r=>{
    const b=document.createElement('button');
    b.textContent=r;
    b.onclick=()=>{
      addReaction(msg.dataset.id,r);
      picker.remove();
    };
    picker.appendChild(b);
  });
  document.body.appendChild(picker);
  const r=msg.getBoundingClientRect();
  picker.style.left=Math.min(r.left,window.innerWidth-160)+'px';
  picker.style.top=(r.top-42)+'px';
}

function addReaction(id,emoji){
  if(!reactions.has(id)) reactions.set(id,new Map());
  const map=reactions.get(id);
  map.set(emoji,(map.get(emoji)||0)+1);
  renderReactions(id);
  sync.postMessage({type:'react',id,emoji});
}

function renderReactions(id){
  const el=document.querySelector(`[data-id="${id}"] .reactions`);
  if(!el) return;
  el.innerHTML='';
  reactions.get(id)?.forEach((v,k)=>{
    el.innerHTML+=`<span class="px-2 py-1 bg-bg rounded-full text-xs">${k} ${v}</span>`;
  });
}

/* ================= DB (SAFE VERSION) ================= */
const DB='AbroxDB',STORE='messages';
let db;
const req=indexedDB.open(DB,2);
req.onupgradeneeded=e=>{
  const db=e.target.result;
  if(!db.objectStoreNames.contains(STORE))
    db.createObjectStore(STORE,{keyPath:'id'});
};
req.onsuccess=e=>{
  db=e.target.result;
  db.transaction(STORE).objectStore(STORE).getAll().onsuccess=ga=>{
    (ga.target.result||[]).sort((a,b)=>a.timestamp-b.timestamp).forEach(render);
  };
};
function save(m){
  try{db.transaction(STORE,'readwrite').objectStore(STORE).put(m)}catch{}
}

/* ================= SYNC ================= */
const sync=new BroadcastChannel('AbroxSync');
sync.onmessage=e=>{
  if(e.data.type==='msg') render(e.data.m);
  if(e.data.type==='read') markRead(e.data.id);
  if(e.data.type==='react') addReaction(e.data.id,e.data.emoji);
};

/* ================= SIDEBAR ================= */
membersBtn.onclick=()=>sidebar.classList.toggle('translate-x-full');
closeSidebar.onclick=()=>sidebar.classList.add('translate-x-full');

/* ================= SAMPLE INCOMING ================= */
setTimeout(()=>{
  postMessage({name:ADMIN.name,role:'ADMIN',text:'Welcome everyone ðŸ‘‹ Please follow the rules.',out:false});
  postMessage({name:MOD.name,role:'MOD',text:'Verified members can now chat.',out:false});
},800);
</script>

</body>
</html>
