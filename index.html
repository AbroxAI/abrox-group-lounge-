<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox ‚Äì Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Abrox">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="emoji-pack.js" defer></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#2ecc71',
        bubble:'#262b38',
        bubbleOut:'#2b3242',
        send:'#3b82f6'
      }
    }
  }
}
</script>

<style>
/* ===== TELEGRAM RHYTHM ===== */
.msg{display:flex;gap:8px;margin-bottom:8px}
.grouped{margin-top:-6px}
.msg.out{justify-content:flex-end}

/* ===== BUBBLES ===== */
.bubble{
  padding:8px 14px 7px;
  font-size:13px;
  line-height:1.45;
  max-width:78%;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
}
.msg.in .bubble{background:#262b38;border-radius:6px 18px 18px 6px}
.msg.out .bubble{background:#2b3242;border:1px solid #343a4a;border-radius:18px 6px 6px 18px}
.grouped.in .bubble{border-top-left-radius:18px}
.grouped.out .bubble{border-top-right-radius:18px}

/* ===== TELEGRAM TAIL ===== */
.msg.in .bubble::before{
  content:'';
  position:absolute;
  left:-7px;bottom:6px;
  width:14px;height:14px;
  background:inherit;
  transform:rotate(45deg);
  border-bottom-right-radius:14px;
}
.msg.out .bubble::before{
  content:'';
  position:absolute;
  right:-7px;bottom:6px;
  width:14px;height:14px;
  background:inherit;
  transform:rotate(45deg);
  border-bottom-left-radius:14px;
}
.grouped.in .bubble::before,
.grouped.out .bubble::before{display:none}

/* ===== META ===== */
.sender{font-size:11px;font-weight:600;color:#2ecc71;margin-bottom:4px}
.time{font-size:10px;opacity:.7;margin-top:6px;display:flex;justify-content:flex-end;gap:4px;line-height:1;transform:translateY(1px)}
.read-by{display:flex;gap:4px;margin-top:4px;justify-content:flex-end}
.read-by img{width:13px;height:13px;border-radius:999px;border:1px solid #1c1f26}
.date-sep{text-align:center;font-size:11px;color:#a0a6b5;margin:12px 0}
.typing{font-size:11px;color:#a0a6b5;padding:6px}
.badge{font-size:10px;padding:2px 6px;border-radius:999px}
.badge.admin{background:#e74c3c}
.badge.mod{background:#f39c12}
.badge.verified{background:#2ecc71}

/* Verified pill inside chat bubble (gem + text) - softened */
.verified-bubble{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  background:linear-gradient(180deg,#1b6d46,#125034); /* toned, less neon */
  color:#d8f6e2;
  font-size:11px;
  font-weight:500;
  line-height:1;
  box-shadow:0 1px 0 rgba(0,0,0,.14);
  margin-left:6px;
  vertical-align:middle;
}
.verified-bubble i[data-lucide="gem"]{
  width:9px;height:9px; /* smaller than before */
  display:inline-block;
  stroke:#6fbf98;     /* slightly desaturated */
  stroke-width:0.6;   /* thinner stroke */
  fill:none;
  opacity:0.95;
  transform:translateY(0.6px);
}

/* Sidebar verified pill (text-only) - toned look */
.verified-pill-sidebar{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:5px 10px;
  border-radius:999px;
  background:linear-gradient(180deg,#2a9a64,#1f7a4a); /* darker, less neon */
  color:#f5fff7;
  font-weight:700;
  font-size:11px;
  box-shadow:0 1px 0 rgba(0,0,0,.18);
}

/* ===== VOICE ===== */
.wave{display:flex;gap:3px;align-items:flex-end;height:18px}
.wave span{width:3px;background:#fff;border-radius:2px;animation:wave 1s infinite ease-in-out}
.wave span:nth-child(2){animation-delay:.1s}
.wave span:nth-child(3){animation-delay:.2s}
.wave span:nth-child(4){animation-delay:.3s}
@keyframes wave{0%,100%{height:4px}50%{height:16px}}
.recording{background:#e74c3c;border-radius:999px;padding:6px}

/* ===== AVATAR ===== */
.avatar{width:32px;height:32px;border-radius:999px;margin-top:2px;flex-shrink:0}
.avatar-spacer{width:32px;flex-shrink:0}

/* ===== PATCH 2: PER-MEMBER TYPING (legacy kept) ===== */
.typing-row{
  display:flex;
  gap:8px;
  align-items:flex-end;
  margin:6px 0;
}
.typing-bubble{
  background:#262b38;
  padding:6px 10px;
  border-radius:18px;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
}
.typing-dots{display:flex;gap:3px}
.typing-dots span{
  width:4px;height:4px;
  background:#a0a6b5;
  border-radius:50%;
  animation:typing 1.4s infinite ease-in-out;
}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,80%,100%{opacity:.3}40%{opacity:1}}

/* ===== GROUP TYPING BAR + UNREAD COUNTER ===== */
header{position:relative}

/* header-controls is the container on the right; we position the typing pill relative to it.
   This keeps the pill anchored and vertically centered next to the members/controls without reflow. */
.header-controls{position:relative;min-width:120px;display:flex;align-items:center;gap:8px}

/* group typing pill positioned absolutely inside header-controls (left of controls) */
.group-typing-bar{
  position:absolute;
  right:calc(100% + 8px); /* sit just left of the controls block */
  top:50%;
  transform:translateY(-50%);
  z-index:50;
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:6px 10px;
  min-height:34px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:40vw;
  background:rgba(255,255,255,0.02);
  border-radius:999px;
  font-size:13px;
  color:#a0a6b5;
  transition:opacity .12s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.group-typing-bar .dot{width:8px;height:8px;border-radius:50%;background:#2ecc71;box-shadow:0 0 6px rgba(46,204,113,.12);flex-shrink:0}
.group-typing-bar .typing-summary{overflow:hidden;text-overflow:ellipsis;display:block;color:#2ecc71;font-weight:600}

/* hide only the Members line while typing; keep lock + demo lines visible */
.header-members{display:block}
.header-demo{display:block}
header.typing-active .header-members{display:none}

/* unread counter (small bubble) - immediate left of members button */
.patched-unread-counter{
  background:#2b3242;padding:6px 10px;border-radius:999px;font-size:12px;color:#fff;display:none;min-width:28px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer;z-index:70
}

/* responsive */
@media (max-width:420px){ .group-typing-bar{ max-width:58%; right:calc(100% + 6px); font-size:12px; } }
</style>
</head>

<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">

<header class="bg-panel border-b border-border px-4 py-3 flex items-center justify-between" id="mainHeader">
  <div class="flex gap-3 items-center">
    <img src="assets/logo.png" class="w-8 h-8">
    <div>
      <div class="text-sm font-semibold">Abrox Binary Bot ‚Äì Private Lounge</div>
      <div class="flex items-center gap-1 text-xs text-muted">
        <i data-lucide="lock" class="w-3 h-3"></i>
        <span>Private Group</span>
      </div>
      <div class="text-xs text-muted header-members">
        Members: 4,872 ‚Ä¢ Online: <span id="onlineCount">132</span>
      </div>
      <div class="text-xs text-muted header-demo">
        Demo discussion ¬∑ Verification required
      </div>
    </div>
  </div>

  <div class="header-controls" id="headerControls">
    <div id="unread-counter" class="patched-unread-counter" style="display:none">0</div>
    <div id="group-typing-bar" class="group-typing-bar" style="display:none">
      <div class="dot"></div>
      <div class="typing-summary">Someone is typing‚Ä¶</div>
    </div>
    <button id="membersBtn"><i data-lucide="users"></i></button>
  </div>
</header>

<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-2 scroll-smooth">
  <div class="text-center text-muted text-sm">
    üìå <strong>Group Rules</strong><br>
    New members are read-only until verified<br>
    Admins DM individually<br>
    No screenshots in chat<br>
    Ignore unsolicited messages
  </div>
</section>

<div id="typing" class="typing hidden">Someone is typing‚Ä¶</div>

<footer class="bg-panel border-t border-border px-4 py-3">
  <div id="recordTimer" class="typing hidden text-center text-red-500">‚óè 0:00</div>
  <div class="flex items-center bg-bg rounded-full px-3 py-2 gap-2">
    <button id="emojiBtn"><i data-lucide="smile"></i></button>
    <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
    <div class="flex items-center gap-2 ml-auto">
      <button id="mediaBtn"><i data-lucide="paperclip"></i></button>
      <button id="micBtn"><i data-lucide="mic"></i></button>
      <button id="send" class="hidden text-send"><i data-lucide="send"></i></button>
    </div>
  </div>
</footer>

</main>

<aside id="sidebar" class="fixed right-0 top-0 w-72 h-full bg-panel border-l border-border translate-x-full transition-transform z-50 flex flex-col">
  <div class="p-4 border-b border-border flex items-center justify-between">
    <strong>Members</strong>
    <button id="closeSidebar"><i data-lucide="x"></i></button>
  </div>
  <div style="padding:0 12px 8px 12px">
    <input id="memberSearch" placeholder="Search members..." />
  </div>
  <div id="memberList" class="flex-1 p-3 space-y-4 overflow-y-auto"></div>
</aside>

<input type="file" id="fileInput" class="hidden">
</div>

<script>
lucide.createIcons();

/* ================= FULL LOGIC (anchored header pill + softened gem) ================= */

const chat=document.getElementById('chat');
const input=document.getElementById('input');
const send=document.getElementById('send');
const emojiBtn=document.getElementById('emojiBtn');
const mediaBtn=document.getElementById('mediaBtn');
const micBtn=document.getElementById('micBtn');
const fileInput=document.getElementById('fileInput');
const recordTimer=document.getElementById('recordTimer');
const sidebar=document.getElementById('sidebar');
const membersBtn=document.getElementById('membersBtn');
const closeSidebar=document.getElementById('closeSidebar');
const memberList=document.getElementById('memberList');
const onlineCount=document.getElementById('onlineCount');
const groupTypingBar=document.getElementById('group-typing-bar');
const unreadCounter=document.getElementById('unread-counter');
const memberSearch=document.getElementById('memberSearch');
const headerMembers=document.querySelector('.header-members');
const headerDemo=document.querySelector('.header-demo');
const mainHeader=document.getElementById('mainHeader');

/* EMOJI */
emojiBtn.onclick=()=>EmojiPack.openPicker(input);

/* INPUT UI TOGGLE */
input.oninput=()=>{
  const hasText=input.value.trim().length>0;
  send.classList.toggle('hidden',!hasText);
  mediaBtn.classList.toggle('hidden',hasText);
  micBtn.classList.toggle('hidden',hasText);
};

/* MEDIA PICKER */
mediaBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  if(!e.target.files.length)return;
  const f=e.target.files[0];
  const url=URL.createObjectURL(f);
  let html;
  if(f.type.startsWith('image/')) html=`<img src="${url}" class="rounded-lg max-w-full">`;
  else if(f.type.startsWith('video/')) html=`<video src="${url}" controls class="rounded-lg max-w-full"></video>`;
  else if(f.type.startsWith('audio/')) html=`<audio src="${url}" controls></audio>`;
  else html=`üìé ${f.name}`;
  const m={name:'You',role:'VERIFIED',text:html,timestamp:Date.now(),out:true};
  save(m); render(m);
  fileInput.value='';
};

/* ===== VOICE RECORDING ===== */
let recorder,chunks=[],recStart,recTick;
let holding=false,stream=null;

function startUI(){
  recStart=Date.now();
  recordTimer.classList.remove('hidden');
  recTick=setInterval(()=>{
    const s=Math.floor((Date.now()-recStart)/1000);
    recordTimer.textContent=`‚óè ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  },1000);
  micBtn.classList.add('recording');
  micBtn.innerHTML=`<div class="wave"><span></span><span></span><span></span><span></span></div>`;
}
function stopUI(){
  clearInterval(recTick);
  recordTimer.classList.add('hidden');
  micBtn.classList.remove('recording');
  micBtn.innerHTML='<i data-lucide="mic"></i>';
  lucide.createIcons();
}
async function startRecording(){
  try { stream=await navigator.mediaDevices.getUserMedia({audio:true}); }
  catch(err){ console.warn('Microphone access denied or unavailable',err); return; }
  recorder=new MediaRecorder(stream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'audio/webm'});
    const url=URL.createObjectURL(blob);
    const m={name:'You',role:'VERIFIED',out:true,type:'voice',timestamp:Date.now(),text:`<audio controls src="${url}"></audio>`};
    save(m);render(m);
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  };
  recorder.start();
}
function stopRecording(){
  if(recorder&&recorder.state==='recording')recorder.stop();
}

/* POINTER EVENTS */
micBtn.addEventListener('pointerdown',async e=>{
  e.preventDefault();
  holding=true;
  await startRecording();
  setTimeout(()=>{if(holding)startUI();},300);
});
micBtn.addEventListener('pointerup',()=>{if(!holding)return;holding=false;stopUI();stopRecording();});
micBtn.addEventListener('pointerleave',()=>{if(!holding)return;holding=false;stopUI();stopRecording();});

/* ===== MEMBERS ===== */
const ACTIVE=90000;
const ADMIN={name:'Profit Hunter üåê',role:'ADMIN',avatar:'assets/admin.jpg'};
const MOD={name:'Kitty Star ‚≠ê',role:'MOD',avatar:'assets/mod.jpg'};
const members=[ADMIN,MOD,...Array.from({length:25},(_,i)=>({
  name:`Member_${i+1}`,
  role:'VERIFIED',
  avatar:`https://randomuser.me/api/portraits/men/${i+20}.jpg`,
  lastActive:Date.now()-Math.random()*120000
}))];

const isOnline=m=>Date.now()-m.lastActive<ACTIVE;

/* Render members (sidebar): text-only verified pill, priority ordering */
function renderMembers(filter=''){
  const priority = role => {
    const r=(role||'').toUpperCase();
    if(r.includes('ADMIN')) return 0;
    if(r.includes('MOD')) return 1;
    if(r.includes('VERIFIED')) return 2;
    return 3;
  };
  const q=(filter||'').trim().toLowerCase();
  const list = members
    .filter(m => !q || m.name.toLowerCase().includes(q))
    .sort((a,b)=>{
      const pa=priority(a.role), pb=priority(b.role);
      if(pa!==pb) return pa-pb;
      const oa=isOnline(a)?0:1, ob=isOnline(b)?0:1;
      if(oa!==ob) return oa-ob;
      return a.name.localeCompare(b.name);
    });

  memberList.innerHTML='';
  list.forEach(m=>{
    let rightHTML = '';
    const roleUpper = (m.role||'').toUpperCase();
    if(roleUpper === 'VERIFIED'){
      rightHTML = `<span class="verified-pill-sidebar" title="Verified">VERIFIED</span>`;
    } else if(roleUpper.includes('ADMIN') || roleUpper.includes('MOD')){
      rightHTML = `<span class="badge ${m.role.toLowerCase()}">${m.role}</span>`;
    } else if(m.role){
      rightHTML = `<span class="badge ${m.role.toLowerCase()}">${m.role}</span>`;
    }

    memberList.innerHTML += `
    <div class="flex gap-3 items-center">
      <div class="relative">
        <img src="${m.avatar}" class="w-9 h-9 rounded-full">
        <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${isOnline(m)?'bg-green-500':'bg-gray-500'}"></span>
      </div>
      <div>
        <div class="text-sm">${m.name}</div>
        <div style="margin-top:6px">${rightHTML}</div>
      </div>
    </div>`;
  });
  onlineCount.textContent=members.filter(isOnline).length;
}
memberSearch.addEventListener('input', e => { renderMembers(e.target.value); });
setInterval(()=>{ members[Math.floor(Math.random()*members.length)].lastActive=Date.now(); renderMembers(memberSearch.value); },8000);
renderMembers();

/* Sidebar toggle behaviour: show/hide sidebar and hide unread bubble while open */
function openSidebar(){
  sidebar.classList.remove('translate-x-full');
  unreadCounter.style.display = 'none';
}
function closeSidebarFn(){
  sidebar.classList.add('translate-x-full');
  if(unreadCount>0) unreadCounter.style.display='inline-block';
}
membersBtn.onclick = () => {
  if(sidebar.classList.contains('translate-x-full')) openSidebar(); else closeSidebarFn();
};
closeSidebar.onclick = closeSidebarFn;

/* ===== DB ===== */
const DB='AbroxDB',STORE='messages',PAGE=20;
let db,offset=0,loading=false,lastMeta=null,lastDate='';
indexedDB.open(DB,1).onupgradeneeded=e=>{
  e.target.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
};
indexedDB.open(DB,1).onsuccess=e=>{
  db=e.target.result;seed();load();
};
function save(m){
  db.transaction(STORE,'readwrite').objectStore(STORE).add(m);
}
function seed(){
  const st=db.transaction(STORE).objectStore(STORE);
  st.count().onsuccess=e=>{
    if(e.target.result)return;
    [
      {...ADMIN,text:'Welcome to Abrox Private Lounge.',timestamp:Date.now()-86400000,out:false},
      {...MOD,text:'Please read pinned rules before chatting.',timestamp:Date.now()-86300000,out:false}
    ].forEach(save);
  };
}
function load(){
  if(loading)return;
  loading=true;
  db.transaction(STORE).objectStore(STORE).getAll().onsuccess=e=>{
    const all=e.target.result.sort((a,b)=>a.timestamp-b.timestamp);
    const slice=all.slice(Math.max(0,all.length-offset-PAGE),all.length-offset);
    slice.forEach(m=>render(m,true));
    offset+=PAGE;
    loading=false;
  };
}

/* ===== render() ===== */
function render(m,prepend=false){
  const d=new Date(m.timestamp);
  if(d.toDateString()!==lastDate){
    const sep=document.createElement('div');
    sep.className='date-sep';
    sep.textContent=d.toDateString();
    prepend?chat.prepend(sep):chat.appendChild(sep);
    lastDate=d.toDateString();
  }
  const grouped=lastMeta&&lastMeta.sender===m.name&&(d-lastMeta.time)<120000;
  const el=document.createElement('div');
  el.className=`msg ${m.out?'out':'in'} ${grouped?'grouped':''}`;
  let avatarHTML='';
  if(!m.out){
    const user=members.find(u=>u.name===m.name);
    avatarHTML=grouped?`<div class="avatar-spacer"></div>`:`<img class="avatar" src="${user?.avatar||''}">`;
  }

  // show gem verified inside bubble only for VERIFIED role; sidebar uses text-only pill
  const roleUpper=(m.role||'').toUpperCase();
  const verifiedBubbleHTML = roleUpper==='VERIFIED' ? `<span class="verified-bubble"><i data-lucide="gem"></i><span style="font-size:11px">VERIFIED</span></span>` : '';
  const roleBadgeHTML = (roleUpper && roleUpper!=='VERIFIED') ? `<span class="badge ${m.role.toLowerCase()}">${m.role}</span>` : '';

  el.innerHTML=`
    ${avatarHTML}
    <div class="bubble">
      ${!grouped&&!m.out?`<div class="sender">${m.name} ${verifiedBubbleHTML} ${roleBadgeHTML}</div>`:''}
      ${m.text}
      <div class="time">‚úì ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      <div class="read-by"></div>
    </div>`;
  prepend?chat.prepend(el):chat.appendChild(el);

  // render any lucide icons inside the new element (gem)
  lucide.createIcons();

  if(m.out)receipts(el);
  if(m.out&&m.type==='voice'){
    let t;
    el.addEventListener('mousedown',()=>t=setTimeout(()=>{
      el.remove();
      const tx=db.transaction(STORE,'readwrite').objectStore(STORE);
      tx.getAll().onsuccess=e=>{
        e.target.result.forEach(r=>{if(r.timestamp===m.timestamp)tx.delete(r.id);});
      };
    },800));
    ['mouseup','mouseleave'].forEach(e=>el.addEventListener(e,()=>clearTimeout(t)));
  }

  // when an incoming message is rendered, cancel typing (ghost typing prevention) and manage unread.
  handleIncomingMessage(m);

  lastMeta={sender:m.name,time:d};
}
function receipts(el){
  const t=el.querySelector('.time');
  const r=el.querySelector('.read-by');
  setTimeout(()=>t.textContent=`‚úì‚úì ${t.textContent.slice(2)}`,600);
  setTimeout(()=>{
    t.textContent=`‚úì‚úì üëÄ ${t.textContent.slice(2)}`;
    [ADMIN,MOD].forEach(u=>{
      const img=document.createElement('img');
      img.src=u.avatar;
      r.appendChild(img);
    });
  },1400);
}

/* ===== TYPING ENGINE & GROUP-HEADER LOGIC (human-like + header overlay) ===== */

/* Active typers map */
const activeTypers = new Map();

/* config */
const ADMIN_ROLES = new Set(['ADMIN','ADMINISTRATOR','OWNER']);
const TYPING_BASE_WPM = 40;
const NIGHT_SLOW_FACTOR = 1.6;
const ADMIN_PAUSE_MULTIPLIER = 1.4;
const MAX_VISIBLE_NAMES = 3;

/* unread count helpers */
let unreadCount = 0;
function isUserAtBottom(){
  return chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 10;
}
function incrementUnread(){
  unreadCount++;
  unreadCounter.textContent = unreadCount;
  unreadCounter.style.display = 'inline-block';
}
function clearUnread(){
  unreadCount = 0;
  unreadCounter.style.display = 'none';
  unreadCounter.textContent = '';
}

/* handle scroll: preserve load on top and manage typing pause/resume */
chat.addEventListener('scroll', ()=>{
  if(chat.scrollTop===0) load();
  if(isUserAtBottom()){
    resumeTypingAfterPause();
    clearUnread();
  } else {
    pauseTypingForContextChange();
  }
});
unreadCounter.addEventListener('click', ()=>{ chat.scrollTop = chat.scrollHeight; clearUnread(); });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) pauseTypingForContextChange(); else resumeTypingAfterPause(); });

/* helper: time-of-day */
function isNightTime(){ const hr=new Date().getHours(); return (hr<7 || hr>=22); }

/* start typing simulation for a member */
function startTypingSimulation(member, text='', options={}){
  if(activeTypers.has(member.name)) return;
  const role=(member.role||'').toUpperCase();
  const isAdmin = ADMIN_ROLES.has(role);

  const entry = {
    member,
    state:'starting',
    timers: [],
    paused: false,
    originalText: text,
    startedAt: Date.now(),
    urgent: !!options.urgent
  };
  activeTypers.set(member.name, entry);
  updateTypingHeader();

  // compute duration
  const wordCount = (text && text.trim()) ? text.trim().split(/\s+/).length : Math.max(1, Math.floor(Math.random()*8)+1);
  let wpm = TYPING_BASE_WPM;
  if(/[!?]{2,}/.test(text)) wpm *= 1.15;
  if(text && text.includes('http')) wpm *= 0.9;
  if(options.urgent) wpm *= 1.5;
  if(isNightTime()) wpm /= NIGHT_SLOW_FACTOR;
  if(isAdmin) wpm /= ADMIN_PAUSE_MULTIPLIER;

  const minutes = wordCount / wpm;
  const totalMs = Math.max(400, Math.floor(minutes * 60 * 1000));
  let elapsed = 0;

  // random start delay
  const startDelay = 200 + Math.random()*900;
  entry.timers.push(setTimeout(()=>{ if(entry.paused) return; entry.state='typing'; updateTypingHeader(); }, startDelay));
  elapsed += startDelay;

  const chunks = 2 + Math.floor(Math.random()*3);
  for(let i=0;i<chunks;i++){
    const chunkMs = Math.floor(totalMs/chunks * (0.7 + Math.random()*0.6));
    entry.timers.push(setTimeout(()=>{ if(entry.paused) return; entry.state='typing'; updateTypingHeader(); }, elapsed));
    elapsed += chunkMs;

    if(i < chunks-1){
      const pauseMs = 150 + Math.random()*(isAdmin?900:500);
      entry.timers.push(setTimeout(()=>{ if(entry.paused) return; entry.state='paused'; updateTypingHeader();
        setTimeout(()=>{ if(entry.paused) return; entry.state='typing'; updateTypingHeader(); }, 150 + Math.random()*400);
      }, elapsed));
      elapsed += pauseMs;
    }
  }

  const typoChance = isAdmin?0.35:0.12;
  if(Math.random() < typoChance){
    const typoDelay = Math.max(200, Math.min(totalMs-100, 300 + Math.random()*(totalMs-300)));
    entry.timers.push(setTimeout(()=>{ if(entry.paused) return; entry.state='typo'; updateTypingHeader();
      setTimeout(()=>{ if(entry.paused) return; entry.state='typing'; updateTypingHeader(); }, 250 + Math.random()*500);
    }, typoDelay));
  }

  let finishDelay = 150 + Math.random()*600;
  if(text && text.includes('http')) finishDelay += 400 + Math.random()*800;

  entry.timers.push(setTimeout(()=>{ if(entry.paused) return; entry.state='sending'; updateTypingHeader(); dispatchTypingFinished(member.name, text); setTimeout(()=>{ stopTyping(member.name); }, 300 + Math.random()*500); }, elapsed + finishDelay));

  updateTypingHeader();
}

/* stop/pause/resume helpers */
function stopTyping(name){ const entry = activeTypers.get(name); if(!entry) return; entry.timers.forEach(t=>clearTimeout(t)); activeTypers.delete(name); updateTypingHeader(); }
function cancelTypingExcept(keepName=null){ for(const name of Array.from(activeTypers.keys())){ if(name !== keepName) stopTyping(name); } }
function pauseTypingForContextChange(){ for(const [name, entry] of activeTypers.entries()){ if(!entry.paused){ entry.paused = true; entry.timers.forEach(t=>clearTimeout(t)); entry.timers = []; } } if(groupTypingBar) groupTypingBar.style.display = 'none'; mainHeader.classList.remove('typing-active'); }
function resumeTypingAfterPause(){ for(const [name, entry] of activeTypers.entries()){ if(entry.paused){ entry.paused = false; entry.state = 'typing'; updateTypingHeader(); const resumeDelay = 150 + Math.random()*600; const t = setTimeout(()=>{ dispatchTypingFinished(name, entry.originalText); stopTyping(name); }, resumeDelay); entry.timers.push(t); } } if(activeTypers.size && groupTypingBar) groupTypingBar.style.display = ''; }

/* throttle header updates to avoid glitch/reflow */
let headerRaf = null;
function updateTypingHeader(){
  if(!groupTypingBar) return;
  if(headerRaf) cancelAnimationFrame(headerRaf);
  headerRaf = requestAnimationFrame(()=>{
    const typers = Array.from(activeTypers.values()).map(e=>e.member);
    if(typers.length === 0){
      groupTypingBar.style.display = 'none';
      groupTypingBar.innerHTML = `<div class="dot"></div><div class="typing-summary"></div>`;
      mainHeader.classList.remove('typing-active');
      return;
    }

    // admins first
    typers.sort((a,b)=>{
      const pa = ADMIN_ROLES.has((a.role||'').toUpperCase())?0:1;
      const pb = ADMIN_ROLES.has((b.role||'').toUpperCase())?0:1;
      if(pa!==pb) return pa-pb;
      return 0;
    });

    const buildName = m => `<strong class="typing-name" style="font-weight:600">${escapeHtml(m.name)}</strong>`;
    let html = '';
    if(typers.length === 1) html = `${buildName(typers[0])} is typing‚Ä¶`;
    else if(typers.length <= MAX_VISIBLE_NAMES) html = `${typers.map(buildName).join(', ')} are typing‚Ä¶`;
    else html = `${typers.length} people are typing‚Ä¶`;

    groupTypingBar.innerHTML = `<div class="dot"></div><div class="typing-summary">${html}</div>`;
    groupTypingBar.style.display = '';
    // show typing pill and hide only the members line (demo remains)
    mainHeader.classList.add('typing-active');
  });
}

/* finished typing -> emit to render message */
function dispatchTypingFinished(name, text){ const ev = new CustomEvent('typingFinished', { detail: { name, text }}); window.dispatchEvent(ev); }
window.addEventListener('typingFinished', (e) => {
  const { name, text } = e.detail;
  const member = members.find(m => m.name === name);
  if(!member){ stopTyping(name); return; }
  cancelTypingExcept(name);
  const m = { name: member.name, role: member.role, text: text || '‚Ä¶', timestamp: Date.now(), out: false };
  save(m); render(m);
  if(!isUserAtBottom()) incrementUnread();
  else chat.scrollTop = chat.scrollHeight;
});

/* expose old API names */
function showTyping(member, text=''){ startTypingSimulation(member, text); }
function hideTyping(member){ stopTyping(member.name || member); }
function fakeMemberSend(member,text){ startTypingSimulation(member,text); }

/* simulate members typing */
if(typeof members !== 'undefined'){
  if(!window._groupTypingSimInterval){
    window._groupTypingSimInterval = setInterval(()=>{
      if(!members || members.length === 0) return;
      const m = members[Math.floor(Math.random()*members.length)];
      startTypingSimulation(m, 'Typing indicator now works per-member ‚úÖ');
    },16000);
  }
}

/* SEND handler (preserves original behavior) */
send.onclick=()=>{
  if(!input.value.trim())return;
  const m={name:'You',role:'VERIFIED',text:input.value,timestamp:Date.now(),out:true};
  save(m);render(m);
  input.value='';
  send.classList.add('hidden');
  mediaBtn.classList.remove('hidden');
  micBtn.classList.remove('hidden');
  cancelTypingExcept('You');
  if(isUserAtBottom()) chat.scrollTop = chat.scrollHeight;
};

/* handle incoming message: stop typing for that member and manage unread counter */
function handleIncomingMessage(m){
  cancelTypingExcept(m.name);
  if(!isUserAtBottom() && !(m.out && m.name === 'You')) incrementUnread();
}

/* small util */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* render initial lucide icons */
lucide.createIcons();

/* legacy per-message typing rows (kept for compatibility) */
const typingMap=new Map();
function legacy_showTyping(member){
  if(typingMap.has(member.name))return;
  const row=document.createElement('div');
  row.className='typing-row';
  row.innerHTML=`
    <img class="avatar" src="${member.avatar}">
    <div class="typing-bubble">
      <strong>${member.name}</strong>
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>`;
  chat.appendChild(row);
  chat.scrollTop=chat.scrollHeight;
  typingMap.set(member.name,row);
}
function legacy_hideTyping(member){
  const row=typingMap.get(member.name);
  if(row){row.remove();typingMap.delete(member.name);}
}
window.showTyping = showTyping;
window.hideTyping = hideTyping;
window.fakeMemberSend = fakeMemberSend;
</script>
</body>
</html>
