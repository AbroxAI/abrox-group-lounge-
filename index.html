<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox ‚Äì Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Abrox">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="emoji-pack.js" defer></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#2ecc71',
        bubble:'#262b38',
        bubbleOut:'#2b3242',
        send:'#3b82f6'
      }
    }
  }
}
</script>

<style>
/* ===== TELEGRAM RHYTHM ===== */
.msg{display:flex;gap:8px;margin-bottom:8px}
.grouped{margin-top:-6px}
.msg.out{justify-content:flex-end}

/* ===== BUBBLES ===== */
.bubble{
  padding:8px 14px 7px;
  font-size:13px;
  line-height:1.45;
  max-width:78%;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
}
.msg.in .bubble{background:#262b38;border-radius:6px 18px 18px 6px}
.msg.out .bubble{background:#2b3242;border:1px solid #343a4a;border-radius:18px 6px 6px 18px}
.grouped.in .bubble{border-top-left-radius:18px}
.grouped.out .bubble{border-top-right-radius:18px}

/* ===== TELEGRAM TAIL ===== */
.msg.in .bubble::before{
  content:'';
  position:absolute;
  left:-7px;bottom:6px;
  width:14px;height:14px;
  background:inherit;
  transform:rotate(45deg);
  border-bottom-right-radius:14px;
}
.msg.out .bubble::before{
  content:'';
  position:absolute;
  right:-7px;bottom:6px;
  width:14px;height:14px;
  background:inherit;
  transform:rotate(45deg);
  border-bottom-left-radius:14px;
}
.grouped.in .bubble::before,
.grouped.out .bubble::before{display:none}

/* ===== META ===== */
.sender{font-size:11px;font-weight:600;color:#2ecc71;margin-bottom:4px}
.time{font-size:10px;opacity:.7;margin-top:6px;display:flex;justify-content:flex-end;gap:4px}
.read-by{display:flex;gap:4px;margin-top:4px;justify-content:flex-end}
.read-by img{width:13px;height:13px;border-radius:999px;border:1px solid #1c1f26}
.date-sep{text-align:center;font-size:11px;color:#a0a6b5;margin:12px 0}
.typing{font-size:11px;color:#a0a6b5;padding:6px}
.badge{font-size:10px;padding:2px 6px;border-radius:999px}
.badge.admin{background:#e74c3c}
.badge.mod{background:#f39c12}
.badge.verified{background:#2ecc71}

/* ===== VERIFIED GEM (SURGICAL SCALE FIX) ===== */
.verified-bubble{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  background:linear-gradient(180deg,#1b6d46,#125034);
  color:#d8f6e2;
  font-size:11px;
  font-weight:500;
}
.verified-bubble i[data-lucide="gem"]{
  width:8px;height:8px;
  stroke-width:0.45;
  opacity:.95;
}

/* ===== GROUP TYPING BAR ===== */
header{position:relative}
.header-controls{position:relative;display:flex;align-items:center;gap:8px}

.group-typing-bar{
  position:absolute;
  right:calc(100% + 2px);
  top:50%;
  transform:translateY(-50%);
  display:none;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.03);
  font-size:13px;
  color:#a0a6b5;
}
.group-typing-bar .dot{
  width:8px;height:8px;
  border-radius:50%;
  background:#2ecc71;
}
.group-typing-bar .typing-summary{
  color:#2ecc71;
  font-weight:600;
}

.header-members{display:block}
header.typing-active .header-members{display:none}

/* ===== UNREAD COUNTER ===== */
.patched-unread-counter{
  background:#2b3242;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  display:none;
}

/* small extras */
.verified-pill-sidebar{
  background:linear-gradient(180deg,#1b6d46,#125034);
  color:#d8f6e2;
  padding:2px 6px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
}

/* mic recording UI */
.recording { position: relative; }
.wave { display:inline-flex; gap:4px; align-items:center; }
.wave span { width:4px; height:12px; display:inline-block; background:currentColor; opacity:.8; border-radius:2px; transform-origin:center bottom; animation:wave 800ms infinite; }
.wave span:nth-child(2){ animation-delay:100ms; animation-duration:760ms; }
.wave span:nth-child(3){ animation-delay:200ms; animation-duration:720ms; }
.wave span:nth-child(4){ animation-delay:300ms; animation-duration:700ms; }
@keyframes wave { 0% { transform:scaleY(.4);} 50%{transform:scaleY(1);} 100%{transform:scaleY(.4);} }

.avatar{ width:32px; height:32px; border-radius:999px; }
.avatar-spacer{ width:32px; height:32px; display:inline-block; }

.typing-row{ display:flex; gap:8px; margin:6px 0; align-items:center; }
.typing-bubble{ background:rgba(255,255,255,0.03); padding:8px; border-radius:12px; }
.typing-dots span{ display:inline-block; width:6px; height:6px; background:#a0a6b5; margin-right:4px; border-radius:50%; opacity:.7; animation:dot 1s infinite; }
.typing-dots span:nth-child(2){ animation-delay:120ms; }
.typing-dots span:nth-child(3){ animation-delay:240ms; }
@keyframes dot { 0%{ transform:translateY(0);} 50%{ transform:translateY(-4px);} 100%{ transform:translateY(0);} }

</style>
</head>

<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">

<header class="bg-panel border-b border-border px-4 py-3 flex items-center justify-between" id="mainHeader">
  <div class="flex gap-3 items-center">
    <img src="assets/logo.png" class="w-8 h-8">
    <div>
      <div class="text-sm font-semibold">Abrox Binary Bot ‚Äì Private Lounge</div>
      <div class="flex items-center gap-1 text-xs text-muted">
        <i data-lucide="lock" class="w-3 h-3"></i>
        <span>Private Group</span>
      </div>
      <div class="text-xs text-muted header-members">
        Members: 4,872 ‚Ä¢ Online: <span id="onlineCount">132</span>
      </div>
      <div class="text-xs text-muted header-demo">
        Demo discussion ¬∑ Verification required
      </div>
    </div>
  </div>

  <div class="header-controls">
    <div id="unread-counter" class="patched-unread-counter">0</div>
    <div id="group-typing-bar" class="group-typing-bar">
      <div class="dot"></div>
      <div class="typing-summary">Someone is typing‚Ä¶</div>
    </div>
    <button id="membersBtn"><i data-lucide="users"></i></button>
  </div>
</header>

<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-2 scroll-smooth">
  <div class="text-center text-muted text-sm">
    üìå <strong>Group Rules</strong><br>
    New members are read-only until verified<br>
    Admins DM individually<br>
    No screenshots in chat<br>
    Ignore unsolicited messages
  </div>
</section>

<div id="typing" class="typing hidden">Someone is typing‚Ä¶</div>

<footer class="bg-panel border-t border-border px-4 py-3">
  <div id="recordTimer" class="typing hidden text-center text-red-500">‚óè 0:00</div>
  <div class="flex items-center bg-bg rounded-full px-3 py-2 gap-2">
    <button id="emojiBtn"><i data-lucide="smile"></i></button>
    <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
    <div class="flex items-center gap-2 ml-auto">
      <button id="mediaBtn"><i data-lucide="paperclip"></i></button>
      <button id="micBtn"><i data-lucide="mic"></i></button>
      <button id="send" class="hidden text-send"><i data-lucide="send"></i></button>
    </div>
  </div>
</footer>

</main>

<aside id="sidebar" class="fixed right-0 top-0 w-72 h-full bg-panel border-l border-border translate-x-full transition-transform z-50 flex flex-col">
  <div class="p-4 border-b border-border flex items-center justify-between">
    <strong>Members</strong>
    <button id="closeSidebar"><i data-lucide="x"></i></button>
  </div>

  <div class="px-3 pb-2">
    <input id="memberSearch"
           class="w-full bg-bg border border-border rounded px-3 py-2 text-sm outline-none"
           placeholder="Search members...">
  </div>

  <div id="memberList" class="flex-1 p-3 space-y-4 overflow-y-auto"></div>
</aside>

<input type="file" id="fileInput" class="hidden">
</div>

<script>
/* ================= CORE STATE ================= */
lucide.createIcons();

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const emojiBtn = document.getElementById('emojiBtn');
const mediaBtn = document.getElementById('mediaBtn');
const micBtn = document.getElementById('micBtn');
const fileInput = document.getElementById('fileInput');
const recordTimer = document.getElementById('recordTimer');
const sidebar = document.getElementById('sidebar');
const membersBtn = document.getElementById('membersBtn');
const closeSidebar = document.getElementById('closeSidebar');
const memberList = document.getElementById('memberList');
const onlineCount = document.getElementById('onlineCount');
const groupTypingBar = document.getElementById('group-typing-bar');
const unreadCounter = document.getElementById('unread-counter');
const memberSearch = document.getElementById('memberSearch');
const mainHeader = document.getElementById('mainHeader');

/* ===== EMOJI ===== */
emojiBtn.onclick = () => { if(window.EmojiPack) EmojiPack.openPicker(input); };

/* ===== INPUT TOGGLE ===== */
input.oninput = () => {
  const hasText = input.value.trim().length > 0;
  send.classList.toggle('hidden', !hasText);
  mediaBtn.classList.toggle('hidden', hasText);
  micBtn.classList.toggle('hidden', hasText);
};

/* ===== MEDIA PICKER ===== */
mediaBtn.onclick = () => fileInput.click();
fileInput.onchange = e => {
  if (!e.target.files.length) return;
  const f = e.target.files[0];
  const url = URL.createObjectURL(f);
  let html;
  if (f.type.startsWith('image/')) html = `<img src="${url}" class="rounded-lg max-w-full">`;
  else if (f.type.startsWith('video/')) html = `<video src="${url}" controls class="rounded-lg max-w-full"></video>`;
  else if (f.type.startsWith('audio/')) html = `<audio src="${url}" controls></audio>`;
  else html = `üìé ${f.name}`;
  const m = { name:'You', role:'VERIFIED', text: html, timestamp: Date.now(), out:true };
  save(m); render(m);
  fileInput.value = '';
};

/* ===== VOICE RECORDING ===== */
let recorder, chunks = [], recStart, recTick;
let holding = false, stream = null;

function startUI(){
  recStart = Date.now();
  recordTimer.classList.remove('hidden');
  recTick = setInterval(()=>{
    const s = Math.floor((Date.now()-recStart)/1000);
    recordTimer.textContent = `‚óè ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  },1000);
  micBtn.classList.add('recording');
  micBtn.innerHTML = `<div class="wave"><span></span><span></span><span></span><span></span></div>`;
}
function stopUI(){
  clearInterval(recTick);
  recordTimer.classList.add('hidden');
  micBtn.classList.remove('recording');
  micBtn.innerHTML = '<i data-lucide="mic"></i>';
  lucide.createIcons();
}

async function startRecording(){
  try { stream = await navigator.mediaDevices.getUserMedia({audio:true}); }
  catch(e){ return; }
  recorder = new MediaRecorder(stream);
  chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks,{type:'audio/webm'});
    const url = URL.createObjectURL(blob);
    const m = {
      name:'You', role:'VERIFIED', out:true, type:'voice',
      timestamp:Date.now(), text:`<audio controls src="${url}"></audio>`
    };
    save(m); render(m);
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  };
  recorder.start();
}
function stopRecording(){
  if(recorder && recorder.state==='recording') recorder.stop();
}

/* POINTER EVENTS */
micBtn.addEventListener('pointerdown', async e=>{
  e.preventDefault();
  holding=true;
  await startRecording();
  setTimeout(()=>{ if(holding) startUI(); },300);
});
micBtn.addEventListener('pointerup', ()=>{ if(!holding) return; holding=false; stopUI(); stopRecording(); });
micBtn.addEventListener('pointerleave', ()=>{ if(!holding) return; holding=false; stopUI(); stopRecording(); });

/* ===== MEMBERS ===== */
const ACTIVE = 90000;
const ADMIN = { name:'Profit Hunter üåê', role:'ADMIN', avatar:'assets/admin.jpg' };
const MOD   = { name:'Kitty Star ‚≠ê', role:'MOD', avatar:'assets/mod.jpg' };

const members = [
  ADMIN, MOD,
  ...Array.from({length:25},(_,i)=>({
    name:`Member_${i+1}`,
    role:'VERIFIED',
    avatar:`https://randomuser.me/api/portraits/men/${i+20}.jpg`,
    lastActive:Date.now()-Math.random()*120000
  }))
];

const isOnline = m => Date.now()-m.lastActive < ACTIVE;

function renderMembers(filter=''){
  const q = filter.toLowerCase();
  memberList.innerHTML='';
  members
    .filter(m=>!q||m.name.toLowerCase().includes(q))
    .sort((a,b)=> (isOnline(b)-isOnline(a)) || a.name.localeCompare(b.name))
    .forEach(m=>{
      memberList.innerHTML += `
      <div class="flex gap-3 items-center">
        <div class="relative">
          <img src="${m.avatar}" class="w-9 h-9 rounded-full">
          <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${isOnline(m)?'bg-green-500':'bg-gray-500'}"></span>
        </div>
        <div>
          <div class="text-sm">${m.name}</div>
          ${m.role==='VERIFIED'
            ? `<span class="verified-pill-sidebar">VERIFIED</span>`
            : `<span class="badge ${m.role.toLowerCase()}">${m.role}</span>`
          }
        </div>
      </div>`;
    });
  onlineCount.textContent = members.filter(isOnline).length;
}

memberSearch.addEventListener('input', e=>renderMembers(e.target.value));
setInterval(()=>{
  members[Math.floor(Math.random()*members.length)].lastActive = Date.now();
  renderMembers(memberSearch.value);
},8000);
renderMembers();

/* ===== RENDER ===== */
let lastMeta=null, lastDate='';

function formatTime(ts){
  const d=new Date(ts);
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function render(m, prepend=false){
  const d = new Date(m.timestamp);

  if(d.toDateString() !== lastDate){
    const sep = document.createElement('div');
    sep.className = 'date-sep';
    sep.textContent = d.toDateString();
    prepend ? chat.prepend(sep) : chat.appendChild(sep);
    lastDate = d.toDateString();
  }

  const grouped = lastMeta &&
    lastMeta.sender === m.name &&
    (d - lastMeta.time) < 120000;

  const el = document.createElement('div');
  el.className = `msg ${m.out?'out':'in'} ${grouped?'grouped':''}`;

  let avatarHTML = '';
  if(!m.out){
    const u = members.find(x=>x.name===m.name);
    avatarHTML = grouped
      ? `<div class="avatar-spacer"></div>`
      : `<img class="avatar" src="${u?.avatar||''}">`;
  } else {
    // for outgoing messages, show avatar on right (handled in CSS + innerHTML below)
  }

  const roleUpper = (m.role||'').toUpperCase();
  const verifiedBubbleHTML =
    roleUpper==='VERIFIED'
      ? `<span class="verified-bubble">
           <i data-lucide="gem"></i>
           <span>VERIFIED</span>
         </span>`
      : '';
  const roleBadgeHTML =
    roleUpper && roleUpper!=='VERIFIED'
      ? `<span class="badge ${m.role.toLowerCase()}">${m.role}</span>`
      : '';

  el.innerHTML = `
    ${!m.out ? avatarHTML : ''}
    <div class="bubble">
      ${!grouped && !m.out
        ? `<div class="sender">${m.name} ${verifiedBubbleHTML} ${roleBadgeHTML}</div>`
        : ''}
      ${m.text || ''}
      <div class="time">‚úì ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      <div class="read-by"></div>
    </div>
    ${m.out ? `<img class="avatar" src="${(m.avatar||'https://api.dicebear.com/6.x/identicon/svg?seed='+encodeURIComponent(m.name||'you'))}">` : ''}
  `;

  prepend ? chat.prepend(el) : chat.appendChild(el);
  lucide.createIcons();

  if(m.out) receipts(el);
  handleIncomingMessage(m);

  lastMeta = { sender:m.name, time:d };
}

/* ===== READ RECEIPTS ===== */
function receipts(el){
  const t = el.querySelector('.time');
  const r = el.querySelector('.read-by');
  setTimeout(()=> t.textContent = `‚úì‚úì ${t.textContent.slice(2)}`,600);
  setTimeout(()=>{
    t.textContent = `‚úì‚úì üëÄ ${t.textContent.slice(2)}`;
    [ADMIN,MOD].forEach(u=>{
      const img=document.createElement('img');
      img.src=u.avatar;
      r.appendChild(img);
    });
  },1400);
}

/* ===== UNREAD COUNTER ===== */
let unreadCount = 0;
function isUserAtBottom(){
  return chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 10;
}
function incrementUnread(){
  unreadCount++;
  unreadCounter.textContent = unreadCount;
  unreadCounter.style.display = 'inline-block';
}
function clearUnread(){
  unreadCount = 0;
  unreadCounter.style.display = 'none';
}
unreadCounter.onclick = ()=>{
  chat.scrollTop = chat.scrollHeight;
  clearUnread();
};

/* ===== GROUP TYPING HEADER ===== */
const activeTypers = new Map();

function updateTypingHeader(){
  if(activeTypers.size === 0){
    groupTypingBar.style.display = 'none';
    mainHeader.classList.remove('typing-active');
    return;
  }
  const names = [...activeTypers.keys()].slice(0,3);
  const label =
    names.length === 1
      ? `${names[0]} is typing‚Ä¶`
      : `${names.join(', ')} are typing‚Ä¶`;
  groupTypingBar.querySelector('.typing-summary').textContent = label;
  groupTypingBar.style.display = 'inline-flex';
  mainHeader.classList.add('typing-active');
}

function stopTyping(name){
  activeTypers.delete(name);
  updateTypingHeader();
}
function cancelTypingExcept(name){
  [...activeTypers.keys()].forEach(k=>{
    if(k!==name) activeTypers.delete(k);
  });
  updateTypingHeader();
}

/* ===== INCOMING MESSAGE HANDLER ===== */
function handleIncomingMessage(m){
  stopTyping(m.name);
  if(!isUserAtBottom() && !m.out) incrementUnread();
  else chat.scrollTop = chat.scrollHeight;
}

/* ===== SEND ===== */
send.addEventListener('click', ()=>{
  if(!input.value.trim()) return;
  const m = {
    name:'You',
    role:'VERIFIED',
    text:input.value,
    timestamp:Date.now(),
    out:true
  };
  save(m); render(m);
  input.value='';
  send.classList.add('hidden');
  mediaBtn.classList.remove('hidden');
  micBtn.classList.remove('hidden');
  chat.scrollTop = chat.scrollHeight;
});
input.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    send.click();
  }
});

/* ===== LEGACY TYPING (COMPAT) ===== */
const typingMap = new Map();
function legacy_showTyping(member){
  if(typingMap.has(member.name)) return;
  const row = document.createElement('div');
  row.className='typing-row';
  row.innerHTML = `
    <img class="avatar" src="${member.avatar}">
    <div class="typing-bubble">
      <strong>${member.name}</strong>
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>`;
  chat.appendChild(row);
  typingMap.set(member.name,row);
}
function legacy_hideTyping(member){
  const row = typingMap.get(member.name);
  if(row){ row.remove(); typingMap.delete(member.name); }
}

/* expose APIs */
window.showTyping = m=>{ activeTypers.set(m.name,m); updateTypingHeader(); };
window.hideTyping = m=>stopTyping(m.name||m);
window.fakeMemberSend = (m,t)=>{ activeTypers.set(m.name,m); updateTypingHeader(); };

/* ===== INDEXED DB ===== */
const DB='AbroxDB', STORE='messages';
let db;
const openReq = indexedDB.open(DB,1);
openReq.onupgradeneeded=e=>{
  try {
    e.target.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
  } catch(err){}
};
openReq.onsuccess=e=>{
  db=e.target.result;
  seed(); load();
};
openReq.onerror = e => { console.warn('IndexedDB open error', e); };

function save(m){
  try {
    if(!db) {
      // if DB isn't ready yet, still render locally and queue isn't implemented; best-effort
      console.warn('DB not ready, rendering without save');
      return;
    }
    db.transaction(STORE,'readwrite').objectStore(STORE).add(m);
  } catch (err) {
    console.warn('DB save failed', err);
  }
}
function seed(){
  try {
    const s=db.transaction(STORE).objectStore(STORE);
    s.count().onsuccess=e=>{
      if(e.target.result) return;
      [
        {...ADMIN,text:'Welcome to Abrox Private Lounge.',timestamp:Date.now()-86400000,out:false},
        {...MOD,text:'Please read pinned rules before chatting.',timestamp:Date.now()-86300000,out:false}
      ].forEach(msg=>{ db.transaction(STORE,'readwrite').objectStore(STORE).add(msg); });
    };
  } catch(err){ console.warn('Seed failed', err); }
}
function load(){
  try {
    db.transaction(STORE).objectStore(STORE).getAll().onsuccess=e=>{
      (e.target.result||[]).sort((a,b)=>a.timestamp-b.timestamp).forEach(render);
    };
  } catch(err){ console.warn('Load failed', err); }
}

/* ===== DEMO: simulate external messages ===== */
setInterval(()=>{
  if(Math.random() < 0.25){
    const m = {
      name: members[Math.floor(Math.random()*members.length)].name,
      role: 'VERIFIED',
      text: ['Nice!', 'Confirmed ‚úÖ', 'Check this out', 'On it', 'Lol'][Math.floor(Math.random()*5)],
      timestamp: Date.now(), out:false
    };
    // try to save if DB ready
    if(db) save(m);
    render(m);
    unreadCounter.style.display = '';
    unreadCounter.textContent = Number(unreadCounter.textContent||0) + 1;
    setTimeout(()=>{ unreadCounter.style.display = 'none'; unreadCounter.textContent = 0; }, 3000);
  }
}, 7000);

/* ===== SIDEBAR ===== */
membersBtn.onclick = ()=> sidebar.classList.toggle('translate-x-full');
closeSidebar.onclick = ()=> sidebar.classList.add('translate-x-full');

</script>
</body>
</html>
