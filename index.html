<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox â€“ Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="emoji-pack.js" defer></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#6bdba7',
        bubble:'#262b38',
        bubbleOut:'#2b3242',
        send:'#3b82f6'
      }
    }
  }
}
</script>

<style>
*{box-sizing:border-box}

/* ================= HEADER ================= */
.header{background:#232833;border-bottom:1px solid #343a4a}

/* members / typing rows */
.members-row,.typing-row{
  padding:0 16px;height:22px;font-size:12px;
  display:flex;align-items:center
}
.members-row{color:#a0a6b5}
.typing-row{gap:8px;font-weight:500;color:#6bdba7;display:none}
.typing-row.active{display:flex}
.members-row.hidden{display:none}

/* typing dots */
.typing-dots{display:flex;gap:3px}
.typing-dots span{
  width:4px;height:4px;border-radius:999px;
  background:#6bdba7;opacity:.25;
  animation:blink 1.4s infinite both
}
.typing-dots span:nth-child(2){animation-delay:.15s}
.typing-dots span:nth-child(3){animation-delay:.3s}
@keyframes blink{0%,80%,100%{opacity:.25}40%{opacity:1}}

/* ================= CHAT ================= */
.msg{display:flex;gap:8px;margin-bottom:8px;align-items:flex-end}
.msg.out{justify-content:flex-end}
.grouped{margin-top:-6px}

.avatar{width:36px;height:36px;border-radius:999px}
.msg.grouped .avatar{visibility:hidden}

.bubble{
  max-width:74%;
  padding:8px 14px;
  font-size:14px;
  line-height:1.45;
  position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,.18)
}
.msg.in .bubble{
  background:#262b38;
  border-radius:8px 18px 18px 8px
}
.msg.in .bubble::before{
  content:'';
  position:absolute;
  left:-6px;bottom:14px;
  width:10px;height:10px;
  background:#262b38;
  transform:rotate(45deg)
}
.msg.out .bubble{
  background:#2b3242;
  border:1px solid #343a4a;
  border-radius:18px 8px 8px 18px
}
.msg.out .bubble::after{
  content:'';
  position:absolute;
  right:-6px;bottom:14px;
  width:10px;height:10px;
  background:#2b3242;
  transform:rotate(45deg)
}
.grouped.in .bubble::before,
.grouped.out .bubble::after{display:none}

/* meta */
.sender{
  font-size:12px;font-weight:600;color:#6bdba7;
  margin-bottom:4px;display:flex;gap:6px;align-items:center
}
.time{
  font-size:10px;
  opacity:.55;
  margin-top:6px;
  display:flex;
  gap:6px;
  justify-content:flex-end;
  align-items:center
}

/* ================= DATE PILLS ================= */
.date-pill{
  position:sticky;
  top:8px;
  z-index:10;
  margin:16px auto;
  width:max-content;
  padding:4px 12px;
  border-radius:999px;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(6px);
  font-size:11px;
  opacity:0;
  animation:fadeDate .35s ease forwards;
}
@keyframes fadeDate{to{opacity:1}}

/* ================= REPLY / REACTIONS ================= */
.reply-preview{
  font-size:11px;opacity:.7;
  border-left:2px solid #6bdba7;
  padding-left:6px;margin-bottom:4px;
  cursor:pointer
}
.reactions{display:flex;gap:4px;margin-top:4px}
.reaction{
  background:#1c1f26;border:1px solid #343a4a;
  border-radius:999px;padding:1px 6px;
  font-size:11px;cursor:pointer
}

/* ================= PIN ================= */
.pinned-banner{
  background:#232833;border-bottom:1px solid #343a4a;
  padding:6px 16px;font-size:13px;
  display:flex;gap:8px;align-items:center;cursor:pointer
}
.pinned-banner.hidden{display:none}

/* ================= INPUT / WAVEFORM ================= */
.input-shell{
  display:flex;
  align-items:center;
  background:#1c1f26;
  border-radius:999px;
  padding:6px 10px;
  gap:8px;
  width:100%;
  position:relative;
}

.input-shell.recording{
  padding:6px 14px;
}

#waveform{
  flex:1;
  height:28px;
  display:none;
}
.input-shell.recording #waveform{
  display:block;
}
.input-shell.recording input{
  display:none;
}

/* ================= UNREAD ================= */
#unreadBtn{
  position:fixed;bottom:90px;left:50%;
  transform:translateX(-50%);
  background:#3b82f6;
  color:#fff;
  padding:6px 14px;
  border-radius:999px;
  font-size:12px;
  display:none;
  z-index:40
}

/* ================= SIDEBAR ================= */
#sidebar{transition:transform .25s ease}
#memberSearch{
  width:100%;
  padding:6px 10px;
  border-radius:999px;
  background:#1c1f26;
  border:1px solid #343a4a;
  font-size:12px;
  outline:none;
}

section{-webkit-overflow-scrolling:touch}
</style>
</head>
<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">

<main class="flex flex-col flex-1 border-r border-border">

<header class="header">
  <div class="flex items-center justify-between px-4 py-3">
    <div class="flex gap-3 items-center">
      <img src="assets/logo.png" class="w-9 h-9 rounded">
      <div>
        <div class="text-sm font-semibold">Abrox Binary Bot â€“ Private Lounge</div>
        <div class="flex items-center gap-1 text-xs text-muted">
          <i data-lucide="lock" class="w-3 h-3"></i>
          <span>Private Group</span>
        </div>
      </div>
    </div>
    <button id="membersBtn"><i data-lucide="users"></i></button>
  </div>

  <div class="members-row" id="membersRow">
    Members: <strong id="memberCount">4,872</strong>
    <span class="mx-2">â€¢</span>
    Online: <strong id="onlineCount">0</strong>
  </div>

  <div class="typing-row" id="typingRow">
    <div class="typing-dots"><span></span><span></span><span></span></div>
    <span id="typingText"></span>
  </div>

  <div class="px-4 text-xs text-muted pb-1">
    Demo discussion Â· Verification required
  </div>
</header>

<div id="pinnedBanner" class="pinned-banner hidden">
  <i data-lucide="pin"></i>
  <span id="pinnedText" class="flex-1 truncate"></span>
  <button id="unpinBtn"><i data-lucide="x"></i></button>
</div>

<section id="chat" class="flex-1 overflow-y-auto px-4 py-4">
  <div class="text-center text-muted text-sm mb-4">
    ðŸ“Œ <strong>Group Rules</strong><br>
    New members are read-only until verified<br>
    Admins DM individually<br>
    No screenshots in chat<br>
    Ignore unsolicited messages
  </div>
</section>

<button id="unreadBtn">â¬‡ New messages</button>

<footer class="bg-panel border-t border-border px-4 py-3">
  <div class="flex items-center gap-2">
    <button id="emojiBtn"><i data-lucide="smile"></i></button>

    <div class="input-shell" id="inputShell">
      <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
      <canvas id="waveform"></canvas>
    </div>

    <div class="flex items-center gap-2 ml-auto">
      <button id="mediaBtn"><i data-lucide="paperclip"></i></button>
      <button id="micBtn"><i data-lucide="mic"></i></button>
      <button id="send" class="hidden text-send"><i data-lucide="send"></i></button>
    </div>
  </div>
</footer>

</main>

<aside id="sidebar" class="fixed right-0 top-0 w-72 h-full bg-panel border-l border-border translate-x-full z-50 flex flex-col">
  <div class="p-4 border-b border-border flex justify-between">
    <strong>Members</strong>
    <button id="closeSidebar"><i data-lucide="x"></i></button>
  </div>

  <div class="p-3">
    <input id="memberSearch" placeholder="Search membersâ€¦">
  </div>

  <div id="memberList" class="flex-1 overflow-y-auto p-3 space-y-3"></div>
</aside>

<input type="file" id="fileInput" class="hidden">
<script>
/* ================= INIT ================= */
requestAnimationFrame(()=>lucide.createIcons());

/* ================= CORE ================= */
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const emojiBtn = document.getElementById('emojiBtn');
const mediaBtn = document.getElementById('mediaBtn');
const micBtn = document.getElementById('micBtn');
const fileInput = document.getElementById('fileInput');
const unreadBtn = document.getElementById('unreadBtn');
const inputShell = document.getElementById('inputShell');

const membersRow = document.getElementById('membersRow');
const typingRow = document.getElementById('typingRow');
const typingText = document.getElementById('typingText');
const onlineCountEl = document.getElementById('onlineCount');
const memberCountEl = document.getElementById('memberCount');

const sidebar = document.getElementById('sidebar');
const membersBtn = document.getElementById('membersBtn');
const closeSidebar = document.getElementById('closeSidebar');
const memberList = document.getElementById('memberList');
const memberSearch = document.getElementById('memberSearch');

/* ================= MEMBERS ================= */
const ADMIN = { name:'Profit Hunter ðŸŒ', role:'ADMIN', avatar:'assets/admin.jpg', lastActive:Date.now() };
const MOD   = { name:'Kitty Star â­', role:'MOD', avatar:'assets/mod.jpg', lastActive:Date.now()-60000 };

let members = [ADMIN, MOD];
let targetMembers = 4872;

function addMemberSlowly(){
  if(members.length >= targetMembers) return;
  if(Math.random() > 0.35) return;
  members.push({
    name:`Member_${members.length+1}`,
    role:'VERIFIED',
    avatar:`https://randomuser.me/api/portraits/men/${members.length%90}.jpg`,
    lastActive: Date.now() - Math.random()*600000
  });
}
setInterval(addMemberSlowly, 5000);

/* ================= PRESENCE ================= */
const ONLINE_LIMIT = 90000;
const IDLE_LIMIT   = 300000;

function presence(m){
  const d = Date.now() - m.lastActive;
  if(d < ONLINE_LIMIT) return 'online';
  if(d < IDLE_LIMIT) return 'idle';
  return 'offline';
}

function driftPresence(){
  members.forEach(m=>{
    if(Math.random() < 0.25){
      m.lastActive = Date.now() - Math.random()*400000;
    }
  });
}
setInterval(driftPresence, 4000);

/* ================= MEMBER RENDER ================= */
function renderMembers(){
  const q = memberSearch.value.toLowerCase();
  memberList.innerHTML = '';
  members.filter(m=>m.name.toLowerCase().includes(q)).slice(0,80).forEach(m=>{
    const p = presence(m);
    const color = p==='online'?'bg-green-500':p==='idle'?'bg-yellow-400':'bg-gray-500';
    memberList.innerHTML += `
      <div class="flex gap-3 items-center">
        <div class="relative">
          <img src="${m.avatar}" class="w-9 h-9 rounded-full">
          <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${color}"></span>
        </div>
        <div>
          <div class="text-sm">${m.name}</div>
          <span class="text-[10px] px-2 py-[1px] rounded-full ${
            m.role==='ADMIN'?'bg-red-600':
            m.role==='MOD'?'bg-purple-600':'bg-green-600'
          }">${m.role}</span>
        </div>
      </div>`;
  });

  onlineCountEl.textContent = members.filter(m=>presence(m)==='online').length;
  memberCountEl.textContent = members.length.toLocaleString();
}
setInterval(renderMembers, 3000);
memberSearch.oninput = renderMembers;

/* ================= TYPING ================= */
function showTyping(){
  if(Math.random() > 0.4) return;
  const pool = members.filter(m=>presence(m)==='online' && m.role!=='ADMIN');
  if(!pool.length) return;
  const pick = pool[Math.floor(Math.random()*pool.length)];
  typingText.textContent = `${pick.name} is typingâ€¦`;
  typingRow.classList.add('active');
  membersRow.classList.add('hidden');
  setTimeout(()=>{
    typingRow.classList.remove('active');
    membersRow.classList.remove('hidden');
  },1200+Math.random()*1000);
}
setInterval(showTyping, 5000);

/* ================= INPUT ================= */
input.oninput = ()=>{
  const has = input.value.trim();
  send.classList.toggle('hidden', !has);
  mediaBtn.classList.toggle('hidden', !!has);
  micBtn.classList.toggle('hidden', !!has);
};

/* ================= SEND ================= */
let replyTo = null;
send.onclick = ()=>{
  if(!input.value.trim()) return;
  postMessage({ name:'You', role:'VERIFIED', text:input.value, out:true, replyTo });
  replyTo = null;
  input.value='';
  send.classList.add('hidden');
  mediaBtn.classList.remove('hidden');
  micBtn.classList.remove('hidden');
};

/* ================= EMOJI ================= */
emojiBtn.onclick = ()=>window.EmojiPack && EmojiPack.openPicker(input);

/* ================= MEDIA ================= */
mediaBtn.onclick = ()=>fileInput.click();
fileInput.onchange = e=>{
  if(!e.target.files.length) return;
  const f = e.target.files[0];
  const url = URL.createObjectURL(f);
  postMessage({
    name:'You',
    role:'VERIFIED',
    text: f.type.startsWith('image/') ?
      `<img src="${url}" class="rounded-lg max-w-full">` :
      `ðŸ“Ž ${f.name}`,
    out:true
  });
  fileInput.value='';
};

/* ================= MESSAGE CORE ================= */
let lastSender=null, lastTime=0, lastDate='';
let unread=0;
const seenCache={};

function seenCount(msg){
  if(!seenCache[msg.id]){
    seenCache[msg.id] = 75 + Math.floor(Math.random()*12);
    const grow = setInterval(()=>{
      seenCache[msg.id] += Math.floor(Math.random()*3);
      if(seenCache[msg.id] > onlineCountEl.textContent) clearInterval(grow);
      const el=document.querySelector(`[data-id="${msg.id}"] .time`);
      el && (el.querySelector('span').textContent = seenCache[msg.id]);
    },2000+Math.random()*3000);
  }
  return seenCache[msg.id];
}

function postMessage(m){
  m.id = crypto.randomUUID();
  m.time = Date.now();
  renderMessage(m,true);
}

function dateLabel(d){
  const today = new Date();
  const diff = Math.floor((today - d)/(86400000));
  if(diff===0) return 'Today';
  if(diff===1) return 'Yesterday';
  return d.toDateString();
}

function renderMessage(m,isNew){
  const d = new Date(m.time);

  if(d.toDateString() !== lastDate){
    const pill = document.createElement('div');
    pill.className = 'date-pill';
    pill.textContent = dateLabel(d);
    chat.appendChild(pill);
    lastDate = d.toDateString();
  }

  const grouped = lastSender===m.name && (m.time-lastTime)<120000;
  lastSender = m.name;
  lastTime = m.time;

  const badge =
    m.role==='ADMIN'?'<span class="role-pill admin">ADMIN</span>':
    m.role==='MOD'?'<span class="role-pill mod">MOD</span>':
    '<span class="verified-bubble"><i data-lucide="gem"></i></span>';

  const el=document.createElement('div');
  el.className=`msg ${m.out?'out':'in'} ${grouped?'grouped':''}`;
  el.dataset.id=m.id;

  el.innerHTML=`
    ${!m.out?`<img class="avatar" src="${members.find(x=>x.name===m.name)?.avatar||''}">`:''}
    <div class="bubble">
      ${m.replyTo?`<div class="reply-preview">â†© Reply</div>`:''}
      ${!grouped&&!m.out?`<div class="sender">${m.name} ${badge}</div>`:''}
      <div class="content">${m.text}</div>
      <div class="time">
        <i data-lucide="eye" class="w-3 h-3"></i>
        <span>${m.out?seenCount(m):'Â·'}</span>
        Â· ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
      </div>
    </div>
  `;
  chat.appendChild(el);
  lucide.createIcons();

  if(isNew && chat.scrollTop+chat.clientHeight<chat.scrollHeight-50){
    unread++;
    unreadBtn.textContent=`â¬‡ ${unread} new messages`;
    unreadBtn.style.display='block';
  }else{
    chat.scrollTop=chat.scrollHeight;
  }
}

/* ================= SIDEBAR ================= */
membersBtn.onclick = ()=>sidebar.classList.toggle('translate-x-full');
closeSidebar.onclick = ()=>sidebar.classList.add('translate-x-full');

/* ================= JOIN ================= */
if(!localStorage.getItem('joined')){
  localStorage.setItem('joined','1');
  setTimeout(()=>{
    postMessage({ name:'You', role:'VERIFIED', text:'ðŸ‘‹ You joined the group', out:false });
  },400);
}

/* ================= SAMPLE ================= */
setTimeout(()=>{
  postMessage({name:ADMIN.name,role:'ADMIN',text:'Welcome everyone ðŸ‘‹',out:false});
  postMessage({name:MOD.name,role:'MOD',text:'Please follow the rules.',out:false});
},600);
</script>
<script>
/* ================= MIC + WAVEFORM ================= */
const canvas = document.getElementById('waveform');
const ctx = canvas.getContext('2d');

let audioCtx, analyser, micStream, mediaRecorder;
let waveAnim, locked=false, recording=false;
let chunks=[];

function resizeWave(){
  canvas.width = inputShell.offsetWidth;
  canvas.height = inputShell.offsetHeight;
}
window.addEventListener('resize', resizeWave);
resizeWave();

function drawWave(){
  const data = new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(data);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#3b82f6';
  ctx.beginPath();

  const slice = canvas.width / data.length;
  let x=0;
  for(let i=0;i<data.length;i++){
    const v = data[i]/128;
    const y = (v*canvas.height)/2;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    x+=slice;
  }
  ctx.stroke();

  waveAnim = requestAnimationFrame(drawWave);
}

async function startMic(){
  recording=true;
  locked=false;
  input.style.display='none';
  canvas.style.display='block';

  micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;

  const source = audioCtx.createMediaStreamSource(micStream);
  source.connect(analyser);

  mediaRecorder = new MediaRecorder(micStream);
  mediaRecorder.ondataavailable = e=>chunks.push(e.data);
  mediaRecorder.onstop = ()=>{
    cancelAnimationFrame(waveAnim);
    canvas.style.display='none';
    input.style.display='block';

    if(chunks.length){
      const blob = new Blob(chunks,{type:'audio/webm'});
      const url = URL.createObjectURL(blob);
      postMessage({
        name:'You',
        role:'VERIFIED',
        text:`<audio controls src="${url}"></audio>`,
        out:true
      });
    }
    chunks=[];
    micStream.getTracks().forEach(t=>t.stop());
  };

  mediaRecorder.start();
  drawWave();
}

function stopMic(){
  if(!recording) return;
  recording=false;
  mediaRecorder.stop();
}

micBtn.addEventListener('touchstart',startMic);
micBtn.addEventListener('mousedown',startMic);

micBtn.addEventListener('touchend',()=>!locked&&stopMic());
micBtn.addEventListener('mouseup',()=>!locked&&stopMic());

/* ================= MIC LOCK ================= */
let startY=0;
micBtn.addEventListener('touchstart',e=>{
  startY=e.touches[0].clientY;
});
micBtn.addEventListener('touchmove',e=>{
  if(!recording) return;
  const diff = startY - e.touches[0].clientY;
  if(diff>60){
    locked=true;
  }
});

/* ================= SWIPE TO REPLY ================= */
let swipeX=0, swipingEl=null;

chat.addEventListener('touchstart',e=>{
  const msg = e.target.closest('.msg');
  if(!msg) return;
  swipeX = e.touches[0].clientX;
  swipingEl = msg;
});

chat.addEventListener('touchmove',e=>{
  if(!swipingEl) return;
  const dx = e.touches[0].clientX - swipeX;
  if(dx>50){
    swipingEl.style.transform='translateX(20px)';
  }
});

chat.addEventListener('touchend',()=>{
  if(swipingEl){
    swipingEl.style.transform='';
    replyTo = swipingEl.dataset.id;
    swipingEl=null;
  }
});

/* ================= TAP ANYWHERE CLOSE ================= */
document.addEventListener('click',e=>{
  document.querySelectorAll('.context-menu').forEach(m=>m.remove());
});

/* ================= BOOT SAFETY ================= */
setTimeout(()=>{
  if(chat.children.length<=1){
    postMessage({
      name:ADMIN.name,
      role:'ADMIN',
      text:'Chat initialized successfully.',
      out:false
    });
  }
},1200);
</script>
