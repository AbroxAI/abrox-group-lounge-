<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox – Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">

{{-- Tailwind & Icons --}}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

{{-- Laravel Echo --}}
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<script src="{{ mix('/js/app.js') }}"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#2ecc71',
        bubble:'#262b38',
        recording:'#e74c3c'
      }
    }
  }
}
</script>

<style>
/* ================= CORE STYLES ================= */
.msg{display:flex;gap:8px;align-items:flex-end}
.msg.out{justify-content:flex-end}
.msg .bubble{background:#262b38;padding:10px 12px;font-size:13px;border-radius:14px 14px 14px 4px;max-width:78%}
.msg.out .bubble{border-radius:14px 14px 4px 14}
.time{font-size:10px;color:#a0a6b5;margin-top:4px;text-align:right}
.sender-name{font-size:11px;color:#a0a6b5;margin-bottom:2px}
.typing{font-size:11px;color:#a0a6b5;padding-left:6px;transition:opacity .3s}
.avatar{width:24px;height:24px;border-radius:9999px;object-fit:cover}
.bg-recording{background:#e74c3c!important}
.text-white-important{color:#fff!important}

/* Sidebar */
#sidebarOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:.2s;z-index:40}
#sidebarOverlay.active{opacity:1;pointer-events:auto}
#memberSidebar{position:fixed;top:0;right:0;height:100%;transform:translateX(100%);transition:.3s;z-index:50;display:flex;flex-direction:column}
#memberSidebar.active{transform:translateX(0)}
</style>
</head>

<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">

<!-- ================= HEADER ================= -->
<header class="bg-panel border-b border-border px-4 py-3">
  <div class="flex justify-between">
    <div class="flex gap-4">
      <i data-lucide="arrow-left" class="w-5 h-5 text-muted mt-1"></i>

      <img
        src="{{ asset('assets/logo.png') }}"
        onerror="this.src='{{ asset('assets/default-avatar.png') }}'"
        class="w-10 h-10 object-contain"
      />

      <div class="leading-tight">
        <div class="text-sm font-semibold">Abrox Binary Bot – Private Lounge</div>
        <div class="text-xs text-muted flex items-center gap-1">
          <i data-lucide="lock" class="w-3.5 h-3.5"></i> Private Group
        </div>
        <div class="text-xs text-muted">
          Members: {{ $membersCount }} • Online:
          <span id="onlineCount">{{ $onlineCount }}</span>
        </div>
        <div class="text-[11px] text-muted/80">Demo discussion · Verification required</div>
      </div>
    </div>

    <i id="memberIcon" data-lucide="users" class="w-5 h-5 text-muted cursor-pointer"></i>
  </div>
</header>

<!-- ================= CHAT ================= -->
<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-1">
  <div id="topLoader" class="hidden text-center text-muted text-xs py-2">
    Loading older messages…
  </div>
</section>

<div id="typing" class="typing opacity-0">Someone is typing…</div>

<!-- ================= FOOTER ================= -->
<footer class="bg-panel border-t border-border px-4 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center gap-3 bg-bg rounded-full px-4 py-2 relative">
    <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
    <button id="send" class="bg-accent px-4 py-2 rounded-full">
      <i data-lucide="send" class="w-4 h-4"></i>
    </button>
  </div>

  @include('components.emoji-panel')
</footer>

</main>
</div>

<!-- ================= SIDEBAR OVERLAY ================= -->
<div id="sidebarOverlay"></div>

<!-- ================= MEMBER SIDEBAR ================= -->
<div id="memberSidebar" class="sm:w-64 md:w-80 bg-panel">
  <div class="px-4 py-3 border-b border-border flex justify-between items-center">
    <span class="font-semibold text-sm">Members & Admins</span>
    <button id="closeSidebar">
      <i data-lucide="x" class="w-5 h-5 text-muted"></i>
    </button>
  </div>

  <div class="flex-1 overflow-y-auto p-4 space-y-4">

    {{-- Admins --}}
    <div>
      <div class="text-xs text-muted uppercase mb-2">Admins</div>
      @foreach($admins as $admin)
      <div class="flex items-center gap-2 mb-2">
        <img src="{{ $admin->avatar }}" onerror="this.src='{{ asset('assets/default-avatar.png') }}'" class="avatar">
        <span class="text-sm">{{ $admin->name }}</span>
      </div>
      @endforeach
    </div>

    {{-- Moderators --}}
    <div>
      <div class="text-xs text-muted uppercase mb-2">Moderators</div>
      @foreach($moderators as $moderator)
      <div class="flex items-center gap-2 mb-2">
        <img src="{{ $moderator->avatar }}" onerror="this.src='{{ asset('assets/default-avatar.png') }}'" class="avatar">
        <span class="text-sm">{{ $moderator->name }}</span>
      </div>
      @endforeach
    </div>

  </div>
</div>

<script>
lucide.createIcons();

/* ================= CORE REFERENCES ================= */
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const sidebar = document.getElementById('memberSidebar');
const overlay = document.getElementById('sidebarOverlay');
const memberIcon = document.getElementById('memberIcon');
const closeBtn = document.getElementById('closeSidebar');

/* ================= SIDEBAR ================= */
memberIcon.onclick = () => {
  sidebar.classList.add('active');
  overlay.classList.add('active');
};
closeBtn.onclick = overlay.onclick = () => {
  sidebar.classList.remove('active');
  overlay.classList.remove('active');
};

/* ================= SEND MESSAGE ================= */
send.onclick = () => {
  const msg = input.value.trim();
  if(!msg) return;
  axios.post('/messages', { message: msg });
  input.value = '';
};

/* ================= REAL-TIME MESSAGES ================= */
Echo.private('lounge')
.listen('MessageSent', (e) => {
  chat.innerHTML += `
    <div class="msg">
      <img src="${e.user.avatar}" class="avatar">
      <div>
        <div class="sender-name">${e.user.name}</div>
        <div class="bubble">
          ${e.message}
          <div class="time">${e.time}</div>
        </div>
      </div>
    </div>`;
  chat.scrollTop = chat.scrollHeight;
});

/* ================= PRESENCE (ONLINE COUNT) ================= */
Echo.join('lounge-presence')
.here(users => {
  document.getElementById('onlineCount').textContent = users.length;
})
.joining(() => {
  document.getElementById('onlineCount').textContent++;
})
.leaving(() => {
  document.getElementById('onlineCount').textContent--;
});
</script>

</body>
</html>
