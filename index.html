<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox – Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#1c1f26',
        panel:'#232833',
        border:'#343a4a',
        muted:'#a0a6b5',
        accent:'#2ecc71',
        bubble:'#262b38',
        recording:'#e74c3c'
      }
    }
  }
}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
/* Chat Styles */
.msg{display:flex;gap:8px;align-items:flex-end}
.msg.out{justify-content:flex-end}
.msg .bubble{background:#262b38;padding:10px 12px;font-size:13px;border-radius:14px 14px 14px 4px;max-width:78%;position:relative}
.msg.out .bubble{border-radius:14px 14px 4px 14}
.msg.first-of-group .bubble{border-top-left-radius:14px;border-top-right-radius:14px}
.msg.continuation .bubble{border-radius:4px 14px 4px 14;margin-top:2px}
.time{font-size:10px;color:#a0a6b5;margin-top:4px;text-align:right}
.system{text-align:center;color:#a0a6b5;font-size:13px;margin:12px 0}
.typing{font-size:11px;color:#a0a6b5;padding-left:6px;transition:opacity .3s}
.transition-bg{transition:background-color .2s}
.bg-recording{background:#e74c3c!important}
.text-white-important{color:#fff!important}
.wave-bar{display:inline-block;width:2px;background:#fff;border-radius:2px}
#send i{transition:transform .2s}
#send.send-active i{transform:translateX(4px) rotate(20deg)}
#mic{touch-action:none}
.sender-name{font-size:11px;color:#a0a6b5;margin-bottom:2px}
.avatar{w-6 h-6 rounded-full object-cover}
#topLoader{text-align:center;color:#a0a6b5;padding:8px;font-size:12px}
</style>
</head>
<body class="bg-bg text-white h-[100dvh] overflow-hidden">
<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">

<!-- Header -->
<header class="bg-panel border-b border-border px-4 py-3">
  <div class="flex justify-between">
    <div class="flex gap-4">
      <i data-lucide="arrow-left" class="w-5 h-5 text-muted mt-1"></i>
      <img src="{{ asset('assets/logo.png') }}" class="w-10 h-10 object-contain"/>
      <div class="leading-tight">
        <div class="text-sm font-semibold">Abrox Binary Bot – Private Lounge</div>
        <div class="text-xs text-muted flex items-center gap-1">
          <i data-lucide="lock" class="w-3.5 h-3.5"></i> Private Group
        </div>
        <div class="text-xs text-muted">
          Members: {{ $membersCount }} • Online: <span id="onlineCount">{{ $onlineCount }}</span>
        </div>
        <div class="text-[11px] text-muted/80">Demo discussion · Verification required</div>
      </div>
    </div>
    <i data-lucide="users" class="w-5 h-5 text-muted"></i>
  </div>
</header>

<!-- Chat Section -->
<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-1" data-page="1">
  <div id="topLoader" class="hidden">Loading older messages…</div>
  {{-- Messages injected via JS simulation or backend --}}
</section>

<!-- Typing Indicator -->
<div id="typing" class="typing opacity-0">Someone is typing…</div>

<!-- Footer -->
<footer class="bg-panel border-t border-border px-4 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center gap-3 bg-bg rounded-full px-4 py-2">
      <button id="emojiBtn"><i data-lucide="smile" class="w-5 h-5 text-muted"></i></button>
      <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
      <button onclick="file.click()"><i data-lucide="paperclip" class="w-5 h-5 text-muted"></i></button>
      <input id="file" type="file" hidden>
      <div class="relative w-10 h-10">
          <button id="mic" class="absolute inset-0 bg-white rounded-full flex items-center justify-center transition-bg overflow-hidden">
              <i data-lucide="mic" class="w-5 h-5 text-bg"></i>
              <div id="micWave" class="absolute flex bottom-1 left-1/2 -translate-x-1/2 h-6 gap-1 hidden">
                  <span class="wave-bar"></span><span class="wave-bar"></span>
                  <span class="wave-bar"></span><span class="wave-bar"></span><span class="wave-bar"></span>
              </div>
          </button>
          <button id="send" class="absolute inset-0 hidden bg-accent rounded-full flex items-center justify-center">
              <i data-lucide="send" class="w-5 h-5"></i>
          </button>
      </div>
  </div>

  @include('components.emoji-panel')
</footer>
</main>
</div>

<script>
lucide.createIcons();

// Online count dynamic fetch
async function updateOnlineCount(){
    try {
        const res = await fetch('/api/online-count');
        const data = await res.json();
        document.getElementById('onlineCount').textContent = data.onlineCount;
    } catch(e){console.error(e);}
}
setInterval(updateOnlineCount,5000);

// Smooth scroll
const chat=document.getElementById('chat');
function scrollToBottom(){chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });}
scrollToBottom();
const observer=new MutationObserver(scrollToBottom);
observer.observe(chat,{ childList:true });

// Chat Elements
const input=document.getElementById('input');
const send=document.getElementById('send');
const mic=document.getElementById('mic');
const micWave=document.getElementById('micWave');
const bars=[...micWave.children];

input.addEventListener('input',()=>{
  const has=input.value.trim();
  send.classList.toggle('hidden',!has);
  mic.classList.toggle('hidden',has);
});

// Voice Recording
let recorder, stream, chunks=[], recording=false, canceled=false, locked=false;
let audioCtx, analyser, data;
const vibrate=ms=>navigator.vibrate&&navigator.vibrate(ms);
async function startRec(e){ e.preventDefault(); if(recording) return; vibrate(30);
stream=await navigator.mediaDevices.getUserMedia({audio:true});
recorder=new MediaRecorder(stream); chunks=[];
recorder.ondataavailable=e=>chunks.push(e.data); recorder.start();
audioCtx=new AudioContext(); analyser=audioCtx.createAnalyser();
audioCtx.createMediaStreamSource(stream).connect(analyser);
data=new Uint8Array(analyser.frequencyBinCount);
recording=true; mic.classList.add('bg-recording'); mic.querySelector('i').classList.add('text-white-important'); micWave.classList.remove('hidden'); animateWave();
}
function animateWave(){ if(!recording) return; analyser.getByteFrequencyData(data); bars.forEach((b,i)=>b.style.height=(data[i]*0.06+4)+'px'); requestAnimationFrame(animateWave);}
function moveRec(e){ if(!recording||locked) return; const p=e.touches?e.touches[0]:e; const r=mic.getBoundingClientRect(); if(p.clientY<r.top-40) locked=true; if(p.clientX<r.left-40) canceled=true;}
function stopRec(){ if(!recording) return; recording=false; mic.classList.remove('bg-recording'); mic.querySelector('i').classList.remove('text-white-important'); micWave.classList.add('hidden'); recorder.stop(); stream.getTracks().forEach(t=>t.stop());
recorder.onstop=()=>{ if(!canceled){ const url=URL.createObjectURL(new Blob(chunks,{type:'audio/webm'}));
chat.innerHTML+=`<div class="msg out"><div class="bubble"><audio controls src="${url}" class="w-full"></audio></div></div>`; }
canceled=false; locked=false;};}

mic.addEventListener('pointerdown',startRec);
mic.addEventListener('pointermove',moveRec);
mic.addEventListener('pointerup',stopRec);
mic.addEventListener('pointercancel',()=>{canceled=true;stopRec()});

// ==========================
// Simulated Real Chat
// ==========================
let demoUsers = []; // loaded from JSON
fetch('/data/demo-users.json').then(r=>r.json()).then(data=>{ demoUsers=data; simulateChat();});

async function simulateChat(){
  for(const msg of demoUsers){
    document.getElementById('typing').classList.remove('opacity-0');
    await new Promise(r=>setTimeout(r, Math.random()*1200+400));
    document.getElementById('typing').classList.add('opacity-0');
    chat.innerHTML += `<div class="msg ${msg.self?'out':''} first-of-group">
      <img src="${msg.avatar}" class="avatar">
      <div class="sender-name">${msg.name}</div>
      <div class="bubble">${msg.text}<div class="time">${new Date(msg.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>
    </div>`;
    scrollToBottom();
    await new Promise(r=>setTimeout(r, Math.random()*800+200));
  }
}

// ==========================
// Infinite Scroll / Top Loader
// ==========================
let loading=false;
chat.addEventListener('scroll',async()=>{
  if(chat.scrollTop<=50 && !loading){
    loading=true;
    const topLoader=document.getElementById('topLoader');
    topLoader.classList.remove('hidden');
    const page=parseInt(chat.dataset.page)+1;
    try{
      const res=await fetch(`/messages?page=${page}`);
      if(res.ok){
        const html=await res.text();
        const firstMessage=chat.querySelector('.msg');
        chat.innerHTML=topLoader.outerHTML+html+chat.innerHTML.replace(topLoader.outerHTML,'');
        if(firstMessage) chat.scrollTop=firstMessage.offsetTop-topLoader.offsetHeight;
        chat.dataset.page=page;
      }
    }catch(e){console.error(e);}
    topLoader.classList.add('hidden');
    loading=false;
  }
});
</script>
</body>
</html>
