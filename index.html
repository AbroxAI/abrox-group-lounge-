<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abrox – Private Lounge</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1c1f26">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
/* Chat Styles */
.msg{display:flex;gap:8px;align-items:flex-end}
.msg.out{justify-content:flex-end}
.msg .bubble{background:#262b38;padding:10px 12px;font-size:13px;border-radius:14px 14px 14px 4px;max-width:78%;position:relative}
.msg.out .bubble{border-radius:14px 14px 4px 14}
.msg.first-of-group .bubble{border-top-left-radius:14px;border-top-right-radius:14px}
.msg.continuation .bubble{border-radius:4px 14px 4px 14;margin-top:2px}
.time{font-size:10px;color:#a0a6b5;margin-top:4px;text-align:right}
.system{text-align:center;color:#a0a6b5;font-size:13px;margin:12px 0}
.typing{font-size:11px;color:#a0a6b5;padding-left:6px;transition:opacity .3s}
.transition-bg{transition:background-color .2s}
.bg-recording{background:#e74c3c!important}
.text-white-important{color:#fff!important}
#send i{transition:transform .2s}
#send.send-active i{transform:translateX(4px) rotate(20deg)}
#mic{touch-action:none;position:relative;}
#lockIcon{position:absolute;left:50%;transform:translateX(-50%) translateY(0) scale(0);transition:transform 0.3s cubic-bezier(.4,0,.2,1);pointer-events:none;}
#lockIcon.show{scale:1;}
.sender-name{font-size:11px;color:#a0a6b5;margin-bottom:2px}
.avatar{w-6 h-6 rounded-full object-cover}
#topLoader{text-align:center;color:#a0a6b5;padding:8px;font-size:12px}
/* Sidebar Overlay */
#sidebarOverlay{position:fixed;inset:0;background:black/50;opacity:0;pointer-events:none;transition:opacity .2s;z-index:40;}
#sidebarOverlay.active{opacity:1;pointer-events:auto;}
/* Sidebar */
#memberSidebar{position:fixed;top:0;right:0;height:100%;transform:translateX(100%);transition:transform .3s;z-index:50;display:flex;flex-direction:column;}
#memberSidebar.active{transform:translateX(0);}

/* New message notification */
#newMessageNotification{
  position:absolute; bottom:80px; left:50%; transform:translateX(-50%);
  background:#2ecc71; color:#fff; padding:6px 12px; border-radius:20px; cursor:pointer; display:none;
  font-size:12px; z-index:100;
}
</style>
</head>
<body class="bg-bg text-white h-[100dvh] overflow-hidden">

<div class="flex h-full">
<main class="flex flex-col flex-1 border-r border-border">
<!-- Header -->
<header class="bg-panel border-b border-border px-4 py-3">
  <div class="flex justify-between">
    <div class="flex gap-4">
      <i data-lucide="arrow-left" class="w-5 h-5 text-muted mt-1"></i>
      <img src="{{ asset('assets/logo.png') }}" class="w-10 h-10 object-contain"/>
      <div class="leading-tight">
        <div class="text-sm font-semibold">Abrox Binary Bot – Private Lounge</div>
        <div class="text-xs text-muted flex items-center gap-1">
          <i data-lucide="lock" class="w-3.5 h-3.5"></i> Private Group
        </div>
        <div class="text-xs text-muted">
          Members: <span id="membersCount">0</span> • Online: <span id="onlineCount">0</span>
        </div>
        <div class="text-[11px] text-muted/80">Demo discussion · Verification required</div>
      </div>
    </div>
    <i id="memberIcon" data-lucide="users" class="w-5 h-5 text-muted cursor-pointer"></i>
  </div>
</header>

<!-- Chat Section -->
<section id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-1 relative" data-page="1">
  <div id="topLoader" class="hidden">Loading older messages…</div>
  <div id="newMessageNotification">New messages</div>
</section>

<!-- Typing Indicator -->
<div id="typing" class="typing opacity-0">Someone is typing…</div>

<!-- Footer -->
<footer class="bg-panel border-t border-border px-4 py-3 pb-[env(safe-area-inset-bottom)]">
  <div class="flex items-center gap-3 bg-bg rounded-full px-4 py-2 relative">
      <button id="emojiBtn"><i data-lucide="smile" class="w-5 h-5 text-muted"></i></button>
      <input id="input" class="flex-1 bg-transparent outline-none text-sm" placeholder="Message">
      <button onclick="fileInput.click()"><i data-lucide="paperclip" class="w-5 h-5 text-muted"></i></button>
      <input id="file" type="file" hidden>

      <div class="relative w-10 h-10">
        <!-- Mic button -->
        <button id="mic" class="absolute inset-0 bg-white rounded-full flex items-center justify-center transition-bg overflow-hidden">
            <i data-lucide="mic" class="w-5 h-5 text-bg"></i>
            <canvas id="micWaveCanvas" class="absolute inset-0 pointer-events-none hidden"></canvas>
            <i id="lockIcon" data-lucide="lock"></i>
        </button>

        <!-- Send button -->
        <button id="send" class="absolute inset-0 hidden bg-accent rounded-full flex items-center justify-center">
            <i data-lucide="send" class="w-5 h-5 text-white"></i>
        </button>
      </div>
  </div>
</footer>
</main>
</div>

<!-- Sidebar Overlay -->
<div id="sidebarOverlay"></div>

<!-- Member Sidebar -->
<div id="memberSidebar" class="sm:w-64 md:w-80" tabindex="-1" aria-label="Member Sidebar">
  <div class="px-4 py-3 border-b border-border flex justify-between items-center">
    <span class="font-semibold text-sm">Members & Admins</span>
    <button id="closeSidebar"><i data-lucide="x" class="w-5 h-5 text-muted"></i></button>
  </div>
  <div class="flex-1 overflow-y-auto p-4 space-y-4">
    <div>
      <div class="text-xs text-muted uppercase mb-2">Admins</div>
      <ul id="adminsList" class="space-y-2"></ul>
    </div>
    <div>
      <div class="text-xs text-muted uppercase mb-2">Moderators</div>
      <ul id="moderatorsList" class="space-y-2"></ul>
    </div>
    <div>
      <div class="text-xs text-muted uppercase mb-2">Verified Members</div>
      <ul id="verifiedList" class="space-y-2"></ul>
    </div>
  </div>
</div>

<script>
lucide.createIcons();

// Sidebar
const memberIcon = document.getElementById('memberIcon');
const sidebar = document.getElementById('memberSidebar');
const overlay = document.getElementById('sidebarOverlay');
const closeBtn = document.getElementById('closeSidebar');
const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
function trapFocus(element){
    const focusableEls = element.querySelectorAll(focusableSelectors);
    if(!focusableEls.length) return;
    const firstEl = focusableEls[0], lastEl = focusableEls[focusableEls.length-1];
    element.addEventListener('keydown', e=>{
        if(e.key==='Tab'){
            if(e.shiftKey && document.activeElement===firstEl){ e.preventDefault(); lastEl.focus(); }
            else if(!e.shiftKey && document.activeElement===lastEl){ e.preventDefault(); firstEl.focus(); }
        } else if(e.key==='Escape'){ closeSidebarFunc(); }
    });
    firstEl.focus();
}
function openSidebar(){ sidebar.classList.add('active'); overlay.classList.add('active'); trapFocus(sidebar); }
function closeSidebarFunc(){ sidebar.classList.remove('active'); overlay.classList.remove('active'); }
memberIcon.addEventListener('click', openSidebar);
closeBtn.addEventListener('click', closeSidebarFunc);
overlay.addEventListener('click', closeSidebarFunc);

// Chat & messages
const input = document.getElementById('input');
const send = document.getElementById('send');
const mic = document.getElementById('mic');
const fileInput = document.getElementById('file');
const chat = document.getElementById('chat');
const notification = document.getElementById('newMessageNotification');

input.addEventListener('input', ()=>{
    const hasText = input.value.trim();
    send.classList.toggle('hidden', !hasText);
    mic.classList.toggle('hidden', hasText);
});

function scrollChatToBottom(force=false){
    const atBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;
    if(force || atBottom){ chat.scrollTo({top: chat.scrollHeight, behavior:'smooth'}); return true; }
    return false;
}

// Current user
const currentUserId = {{ auth()->id() }};
let lastMessageId = null;

// Fetch messages incrementally with notification
async function fetchMessages(){
    try{
        const url = lastMessageId ? `/api/messages?after=${lastMessageId}` : '/api/messages';
        const res = await fetch(url);
        const messages = await res.json();
        if(messages.length===0) return;

        const atBottom = scrollChatToBottom(true); // check if user is at bottom
        messages.forEach(msg=>{
            const content = msg.text ? `<div>${msg.text}</div>` : `<audio controls src="${msg.audio_url}" class="w-full"></audio>`;
            const div = document.createElement('div');
            div.className = `msg ${msg.user_id===currentUserId?'out':'in'}`;
            div.innerHTML = `<div class="bubble">${content}<div class="time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>`;
            chat.appendChild(div);
        });
        lastMessageId = messages[messages.length-1].id;

        if(!atBottom){
            notification.style.display='block';
        } else {
            scrollChatToBottom(true);
        }
    }catch(e){console.error(e);}
}

notification.addEventListener('click', ()=>{
    scrollChatToBottom(true);
    notification.style.display='none';
});

// Send text
send.addEventListener('click', async()=>{
    const text=input.value.trim();
    if(!text) return;
    await fetch('/api/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    input.value='';
    fetchMessages();
});

// Send audio
fileInput.addEventListener('change', async e=>{
    const file = e.target.files[0]; if(!file) return;
    const fd = new FormData(); fd.append('audio', file);
    await fetch('/api/messages',{method:'POST',body:fd});
    fetchMessages();
});

// Users & Online
async function fetchUsers(endpoint, containerId){
    try{ const res = await fetch(endpoint); const users = await res.json();
        document.getElementById(containerId).innerHTML = users.map(u=>`<li class="flex items-center gap-2"><img src="${u.avatar}" class="w-6 h-6 rounded-full"><span class="text-sm">${u.name}</span></li>`).join('');
    }catch(e){console.error(e);}
}
fetchUsers('/api/users/admins','adminsList');
fetchUsers('/api/users/moderators','moderatorsList');
fetchUsers('/api/users/verified','verifiedList');

async function updateOnlineCount(){
    try{
        const res = await fetch('/api/online-count');
        const data = await res.json();
        document.getElementById('onlineCount').textContent = data.onlineCount;
        document.getElementById('membersCount').textContent = data.totalMembers??'0';
    }catch(e){console.error(e);}
}
setInterval(updateOnlineCount,5000); updateOnlineCount();

// Voice recording + waveform + lock
const micWaveCanvas = document.getElementById('micWaveCanvas');
const lockIcon = document.getElementById('lockIcon');
const ctx = micWaveCanvas.getContext('2d');
function resizeCanvas(){ micWaveCanvas.width=micWaveCanvas.clientWidth; micWaveCanvas.height=micWaveCanvas.clientHeight; }
resizeCanvas(); window.addEventListener('resize',resizeCanvas);

let recorder, stream, chunks=[], recording=false, canceled=false, locked=false;
let audioCtx, analyser, dataArray, source;

async function startRec(e){
    e.preventDefault(); if(recording) return;
    navigator.vibrate && navigator.vibrate(30);
    try{ stream=await navigator.mediaDevices.getUserMedia({audio:true}); }catch(err){alert('Microphone access denied');return;}
    recorder=new MediaRecorder(stream); chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data); recorder.start();
    audioCtx=new AudioContext(); analyser=audioCtx.createAnalyser(); analyser.fftSize=2048;
    source=audioCtx.createMediaStreamSource(stream); source.connect(analyser);
    dataArray=new Uint8Array(analyser.fftSize);
    recording=true; mic.classList.add('bg-recording'); mic.querySelector('i').classList.add('text-white-important');
    micWaveCanvas.classList.remove('hidden'); animateWaveSine();
}
function animateWaveSine(){ if(!recording) return; analyser.getByteTimeDomainData(dataArray); const width=micWaveCanvas.width,height=micWaveCanvas.height; ctx.clearRect(0,0,width,height); ctx.beginPath(); ctx.moveTo(0,height/2); let x=0; const sliceWidth=width/dataArray.length; for(let i=0;i<dataArray.length;i++){const v=dataArray[i]/128.0; const y=v*height/2; ctx.lineTo(x,y); x+=sliceWidth;} ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke(); requestAnimationFrame(animateWaveSine);}
function animateLockSlide(){lockIcon.style.transition='transform 0.4s cubic-bezier(.4,0,.2,1)'; lockIcon.style.transform='translateX(-50%) translateY(-60px) scale(1)';}
function moveRec(e){ if(!recording) return; const p=e.touches?e.touches[0]:e; const r=mic.getBoundingClientRect(); if(p.clientY<r.top-50 && !locked){locked=true; animateLockSlide();} if(p.clientX<r.left-40){canceled=true; finishRec();}}
function stopRec(){ if(!recording) return; if(locked) return; finishRec(); }
function finishRec(){ if(!recording) return; recording=false; mic.classList.remove('bg-recording'); mic.querySelector('i').classList.remove('text-white-important'); micWaveCanvas.classList.add('hidden'); lockIcon.style.transform='translateX(-50%) translateY(0) scale(0)'; if(recorder && recorder.state!=="inactive") recorder.stop(); if(stream) stream.getTracks().forEach(t=>t.stop()); recorder.onstop=async()=>{if(!canceled){ const blob=new Blob(chunks,{type:'audio/webm'}); const fd=new FormData(); fd.append('audio',blob,'recording.webm'); await fetch('/api/messages',{method:'POST',body:fd}); fetchMessages(); } canceled=false; locked=false;};

// Periodic fetch
setInterval(fetchMessages,5000);
fetchMessages();
</script>
</body>
</html>
